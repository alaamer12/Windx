{% extends "admin/base.html.jinja" %}

{% block title %}{% if node %}Edit Node{% else %}Create Node{% endif %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/themes/light.css">
<style>
    /* Modern Form Container */
    .form-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    /* Header Section */
    .page-header-enhanced {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 1rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .page-header-enhanced h1 {
        margin: 0 0 0.5rem 0;
        font-size: 1.75rem;
        font-weight: 700;
    }
    
    .page-header-enhanced .breadcrumb {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        display: inline-flex;
        gap: 0.5rem;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    .page-header-enhanced .breadcrumb span {
        opacity: 0.9;
    }
    
    /* Form Layout */
    .form-grid {
        display: grid;
        gap: 1.5rem;
    }
    
    /* Section Cards */
    .form-section-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 1rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .form-section-card:hover {
        border-color: #cbd5e1;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    
    .section-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        padding: 1.25rem 1.5rem;
        border-bottom: 2px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .section-header-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }
    
    .section-header h5 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e293b;
    }
    
    .section-header-description {
        font-size: 0.85rem;
        color: #64748b;
        margin-top: 0.25rem;
    }
    
    .section-content {
        padding: 1.5rem;
    }
    
    /* Form Field Groups */
    .field-grid {
        display: grid;
        gap: 1.25rem;
    }
    
    .field-grid-2 {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .field-grid-3 {
        grid-template-columns: repeat(3, 1fr);
    }
    
    @media (max-width: 768px) {
        .field-grid-2,
        .field-grid-3 {
            grid-template-columns: 1fr;
        }
    }
    
    /* Form Fields */
    .form-field {
        display: flex;
        flex-direction: column;
    }
    
    .form-field label {
        font-weight: 600;
        color: #334155;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .required-badge {
        background: #ef4444;
        color: white;
        font-size: 0.7rem;
        padding: 0.15rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: 600;
    }
    
    /* Tooltip Icon */
    .tooltip-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        font-size: 0.7rem;
        font-weight: 700;
        cursor: help;
        flex-shrink: 0;
    }
    
    .tooltip-icon:hover {
        background: #764ba2;
        transform: scale(1.1);
    }
    
    .form-field input,
    .form-field select,
    .form-field textarea {
        border: 2px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        background: white;
    }
    
    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-field textarea {
        font-family: 'Consolas', 'Monaco', monospace;
        resize: vertical;
        min-height: 80px;
    }
    
    .field-help {
        font-size: 0.85rem;
        color: #64748b;
        margin-top: 0.4rem;
        line-height: 1.4;
    }
    
    .field-help strong {
        color: #334155;
    }
    
    /* Checkbox/Radio Styling */
    .checkbox-field {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 0.5rem;
        border: 2px solid #e2e8f0;
        transition: all 0.2s ease;
    }
    
    .checkbox-field:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
    }
    
    .checkbox-field input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-top: 0.15rem;
        cursor: pointer;
    }
    
    .checkbox-label {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .checkbox-label strong {
        color: #334155;
    }
    
    .checkbox-label .field-help {
        margin-top: 0;
        margin-left: 0.5rem;
    }
    
    /* Alert Styling */
    .alert-enhanced {
        background: #fee2e2;
        border: 2px solid #fecaca;
        border-left: 4px solid #ef4444;
        border-radius: 0.75rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
    }
    
    .alert-enhanced h5 {
        color: #991b1b;
        font-size: 1rem;
        font-weight: 700;
        margin: 0 0 0.75rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .alert-enhanced ul {
        margin: 0;
        padding-left: 1.5rem;
        color: #991b1b;
    }
    
    .alert-enhanced li {
        margin-bottom: 0.5rem;
    }
    
    /* Action Buttons */
    .form-actions-sticky {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 1.5rem;
        border-top: 2px solid #e2e8f0;
        margin: 2rem -1.5rem 0 -1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        z-index: 100;
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    
    .btn-enhanced {
        padding: 0.875rem 2rem;
        border-radius: 0.75rem;
        font-weight: 600;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-primary-enhanced {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary-enhanced:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px -2px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary-enhanced {
        background: white;
        color: #64748b;
        border: 2px solid #e2e8f0;
    }
    
    .btn-secondary-enhanced:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }
    
    /* Info Box */
    .info-box {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-left: 4px solid #3b82f6;
        padding: 1rem 1.25rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .info-box p {
        margin: 0;
        color: #1e40af;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .info-box strong {
        color: #1e3a8a;
    }
    
    /* Select Enhancements */
    select option {
        padding: 0.5rem;
    }
    
    /* Loading State */
    .form-container.loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    /* Tippy.js Custom Theme */
    .tippy-box[data-theme~='custom'] {
        background-color: #1e293b;
        color: white;
        font-size: 0.875rem;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    }
    
    .tippy-box[data-theme~='custom'][data-placement^='top'] > .tippy-arrow::before {
        border-top-color: #1e293b;
    }
    
    .tippy-box[data-theme~='custom'][data-placement^='bottom'] > .tippy-arrow::before {
        border-bottom-color: #1e293b;
    }
    
    .tippy-box[data-theme~='custom'][data-placement^='left'] > .tippy-arrow::before {
        border-left-color: #1e293b;
    }
    
    .tippy-box[data-theme~='custom'][data-placement^='right'] > .tippy-arrow::before {
        border-right-color: #1e293b;
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <!-- Enhanced Header -->
    <div class="page-header-enhanced">
        <h1>
            {% if node %}
            ‚úèÔ∏è Edit Node: {{ node.name }}
            {% else %}
            ‚ûï Create New Node
            {% endif %}
        </h1>
        <div class="breadcrumb">
            <span>üè≠ {{ manufacturing_type.name }}</span>
            <span>‚Üí</span>
            <span>{% if node %}Editing{% else %}Creating{% endif %}</span>
        </div>
    </div>

    <!-- Validation Errors -->
    {% if validation_errors %}
    <div class="alert-enhanced">
        <h5>‚ö†Ô∏è Please Fix These Errors</h5>
        <ul>
            {% for error in validation_errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Info Box -->
    {% if not node %}
    <div class="info-box">
        <p><strong>üí° Creating a new attribute node.</strong> Fill in the required fields below. You can always edit this later. Start with the basics and add details as needed.</p>
    </div>
    {% endif %}

    <!-- Form -->
    <form method="POST" action="/api/v1/admin/hierarchy/node/save" id="nodeForm">
        {% if node %}
        <input type="hidden" name="node_id" value="{{ node.id }}">
        {% endif %}
        <input type="hidden" name="manufacturing_type_id" value="{{ manufacturing_type.id }}">

        <div class="form-grid">
            <!-- Basic Information -->
            <div class="form-section-card">
                <div class="section-header">
                    <div class="section-header-icon">‚ÑπÔ∏è</div>
                    <div>
                        <h5>Basic Information</h5>
                        <div class="section-header-description">Core details about this attribute node</div>
                    </div>
                </div>
                <div class="section-content">
                    <div class="field-grid field-grid-2">
                        <div class="form-field">
                            <label>
                                Node Name
                                <span class="required-badge">Required</span>
                                <span class="tooltip-icon" data-tippy-content="The display name shown to users when configuring products. Should be clear and descriptive.<br><br><strong>Examples:</strong><br>‚Ä¢ 'Frame Material' - for material selection<br>‚Ä¢ 'Glass Type' - for glass options<br>‚Ä¢ 'Width' - for dimension input<br>‚Ä¢ 'Premium Hardware' - for upgrade option">!</span>
                            </label>
                            <input type="text" 
                                   name="name" 
                                   value="{{ form_data.name if form_data else (node.name if node else '') }}"
                                   placeholder="e.g., Frame Material, Glass Type"
                                   required>
                            <div class="field-help">Display name shown to users</div>
                        </div>

                        <div class="form-field">
                            <label>
                                Node Type
                                <span class="required-badge">Required</span>
                                <span class="tooltip-icon" data-tippy-content="Defines the node's role in the hierarchy:<br><br><strong>Category:</strong> Organizational grouping (e.g., 'Frame Options')<br>‚Ä¢ No direct value, contains other nodes<br><br><strong>Attribute:</strong> Configurable property (e.g., 'Material Type')<br>‚Ä¢ Has a data type and can be required<br><br><strong>Option:</strong> Selectable choice (e.g., 'Aluminum', 'Wood')<br>‚Ä¢ Has price/weight impacts<br><br><strong>Component:</strong> Physical part (e.g., 'Handle', 'Lock')<br>‚Ä¢ Represents a product component<br><br><strong>Technical Spec:</strong> Calculated property (e.g., 'U-Value')<br>‚Ä¢ Uses formulas for technical data">!</span>
                            </label>
                            <select name="node_type" required>
                                <option value="">-- Select Type --</option>
                                <option value="category" 
                                        {% if (form_data and form_data.node_type == 'category') or (node and node.node_type == 'category') %}selected{% endif %}>
                                    Category - Organizational grouping
                                </option>
                                <option value="attribute" 
                                        {% if (form_data and form_data.node_type == 'attribute') or (node and node.node_type == 'attribute') %}selected{% endif %}>
                                    Attribute - Configurable property
                                </option>
                                <option value="option" 
                                        {% if (form_data and form_data.node_type == 'option') or (node and node.node_type == 'option') %}selected{% endif %}>
                                    Option - Selectable choice
                                </option>
                                <option value="component" 
                                        {% if (form_data and form_data.node_type == 'component') or (node and node.node_type == 'component') %}selected{% endif %}>
                                    Component - Physical part
                                </option>
                                <option value="technical_spec" 
                                        {% if (form_data and form_data.node_type == 'technical_spec') or (node and node.node_type == 'technical_spec') %}selected{% endif %}>
                                    Technical Spec - Calculated property
                                </option>
                            </select>
                            <div class="field-help">
                                <strong>Category:</strong> Groups related items. 
                                <strong>Attribute:</strong> Configurable property. 
                                <strong>Option:</strong> Selectable choice.
                            </div>
                        </div>

                        <div class="form-field">
                            <label>
                                Parent Node
                                <span class="tooltip-icon" data-tippy-content="The parent node in the hierarchy. Determines where this node appears in the tree structure.<br><br><strong>Effects:</strong><br>‚Ä¢ Defines the LTREE path automatically<br>‚Ä¢ Controls display order and nesting<br>‚Ä¢ Enables conditional display logic<br><br><strong>Examples:</strong><br>‚Ä¢ None (Root) - Top-level category<br>‚Ä¢ 'Frame Options' - Child of root<br>‚Ä¢ 'Material Type' - Child of Frame Options">!</span>
                            </label>
                            <select name="parent_node_id" id="parent_node_id">
                                <option value="">-- None (Root Node) --</option>
                                {% for parent in all_nodes %}
                                <option value="{{ parent.id }}" 
                                        data-depth="{{ parent.depth }}"
                                        {% if (parent_node and parent.id == parent_node.id) or (node and node.parent_node_id == parent.id) or (form_data and form_data.parent_node_id == parent.id) %}selected{% endif %}>
                                    {{ '  ' * parent.depth }}{{ parent.hierarchical_path }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="field-help">Leave empty to create a root-level node</div>
                        </div>

                        <div class="form-field">
                            <label>
                                Data Type
                                <span class="tooltip-icon" data-tippy-content="The type of value stored for this attribute:<br><br><strong>String:</strong> Text values (e.g., 'Aluminum', 'White')<br>‚Ä¢ Stored in string_value column<br><br><strong>Number:</strong> Numeric values (e.g., 48.5, 100)<br>‚Ä¢ Stored in numeric_value column<br>‚Ä¢ Used for dimensions, quantities<br><br><strong>Boolean:</strong> Yes/No choices<br>‚Ä¢ Stored in boolean_value column<br>‚Ä¢ For features (e.g., 'Energy Star Certified')<br><br><strong>Formula:</strong> Calculated values<br>‚Ä¢ Uses formulas for dynamic calculation<br><br><strong>Dimension:</strong> Size measurements<br>‚Ä¢ Special handling for width/height/depth<br><br><strong>Selection:</strong> Choice from predefined options">!</span>
                            </label>
                            <select name="data_type">
                                <option value="">-- Select Data Type --</option>
                                <option value="string" 
                                        {% if (form_data and form_data.data_type == 'string') or (node and node.data_type == 'string') %}selected{% endif %}>
                                    String - Text values
                                </option>
                                <option value="number" 
                                        {% if (form_data and form_data.data_type == 'number') or (node and node.data_type == 'number') %}selected{% endif %}>
                                    Number - Numeric values
                                </option>
                                <option value="boolean" 
                                        {% if (form_data and form_data.data_type == 'boolean') or (node and node.data_type == 'boolean') %}selected{% endif %}>
                                    Boolean - Yes/No choices
                                </option>
                                <option value="formula" 
                                        {% if (form_data and form_data.data_type == 'formula') or (node and node.data_type == 'formula') %}selected{% endif %}>
                                    Formula - Calculated values
                                </option>
                                <option value="dimension" 
                                        {% if (form_data and form_data.data_type == 'dimension') or (node and node.data_type == 'dimension') %}selected{% endif %}>
                                    Dimension - Size measurements
                                </option>
                                <option value="selection" 
                                        {% if (form_data and form_data.data_type == 'selection') or (node and node.data_type == 'selection') %}selected{% endif %}>
                                    Selection - Choice from options
                                </option>
                            </select>
                            <div class="field-help">Type of data stored in this attribute</div>
                        </div>

                        <div class="form-field">
                            <label>
                                Sort Order
                                <span class="tooltip-icon" data-tippy-content="Controls the display order among sibling nodes. Lower numbers appear first.<br><br><strong>Effects:</strong><br>‚Ä¢ Determines UI display sequence<br>‚Ä¢ Only affects nodes at the same level<br>‚Ä¢ Can be reordered anytime<br><br><strong>Examples:</strong><br>‚Ä¢ 0 - First item (e.g., 'Material Type')<br>‚Ä¢ 1 - Second item (e.g., 'Color')<br>‚Ä¢ 10 - Later item (e.g., 'Advanced Options')<br><br><strong>Tip:</strong> Use increments of 10 to allow easy insertion later">!</span>
                            </label>
                            <input type="number" 
                                   name="sort_order" 
                                   value="{{ form_data.sort_order if form_data and form_data.sort_order is not none else (node.sort_order if node else 0) }}"
                                   min="0"
                                   placeholder="0">
                            <div class="field-help">Lower numbers appear first (0, 1, 2...)</div>
                        </div>

                        <div class="form-field">
                            <div class="checkbox-field">
                                <input type="checkbox" 
                                       id="required" 
                                       name="required"
                                       {% if (form_data and form_data.required) or (node and node.required) %}checked{% endif %}>
                                <div class="checkbox-label">
                                    <strong>Required Field</strong>
                                    <span class="tooltip-icon" data-tippy-content="When checked, users MUST provide a value for this attribute before completing their configuration.<br><br><strong>Effects:</strong><br>‚Ä¢ Blocks configuration completion if empty<br>‚Ä¢ Shows validation error if skipped<br>‚Ä¢ Marked with asterisk (*) in UI<br><br><strong>Use for:</strong><br>‚Ä¢ Critical dimensions (Width, Height)<br>‚Ä¢ Essential choices (Frame Material)<br>‚Ä¢ Mandatory specifications<br><br><strong>Don't use for:</strong><br>‚Ä¢ Optional upgrades<br>‚Ä¢ Cosmetic preferences<br>‚Ä¢ Advanced features">!</span>
                                    <div class="field-help">Users must provide a value</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pricing Configuration -->
            <div class="form-section-card">
                <div class="section-header">
                    <div class="section-header-icon">üí∞</div>
                    <div>
                        <h5>Pricing Configuration</h5>
                        <div class="section-header-description">How this node affects product pricing</div>
                    </div>
                </div>
                <div class="section-content">
                    <div class="field-grid field-grid-2">
                        <div class="form-field">
                            <label>
                                Price Impact Type
                                <span class="tooltip-icon" data-tippy-content="How this node affects the total product price:<br><br><strong>Fixed Amount:</strong><br>‚Ä¢ Adds/subtracts a fixed dollar amount<br>‚Ä¢ Example: Aluminum Frame adds $50<br>‚Ä¢ Use Price Impact Value field<br><br><strong>Percentage:</strong><br>‚Ä¢ Adds/subtracts a percentage of current price<br>‚Ä¢ Example: Premium Finish adds 15%<br>‚Ä¢ Value of 15 means 15% increase<br><br><strong>Formula:</strong><br>‚Ä¢ Dynamic calculation based on other values<br>‚Ä¢ Example: width * height * 0.05<br>‚Ä¢ Use Price Formula field<br>‚Ä¢ Can reference: width, height, base_price, etc.<br><br><strong>Calculation Order:</strong><br>1. Base price from manufacturing type<br>2. Fixed amounts added<br>3. Percentages applied<br>4. Formulas calculated">!</span>
                            </label>
                            <select name="price_impact_type">
                                <option value="fixed" 
                                        {% if (form_data and form_data.price_impact_type == 'fixed') or (not form_data and (not node or node.price_impact_type == 'fixed')) %}selected{% endif %}>
                                    Fixed - Add/subtract dollar amount
                                </option>
                                <option value="percentage" 
                                        {% if (form_data and form_data.price_impact_type == 'percentage') or (node and node.price_impact_type == 'percentage') %}selected{% endif %}>
                                    Percentage - Multiply by percentage
                                </option>
                                <option value="formula" 
                                        {% if (form_data and form_data.price_impact_type == 'formula') or (node and node.price_impact_type == 'formula') %}selected{% endif %}>
                                    Formula - Calculate dynamically
                                </option>
                            </select>
                            <div class="field-help">How this affects total price calculation</div>
                        </div>

                        <div class="form-field">
                            <label>
                                Price Impact Value
                                <span class="tooltip-icon" data-tippy-content="The numeric value for price impact (used with Fixed or Percentage types):<br><br><strong>For Fixed Amount:</strong><br>‚Ä¢ Enter dollar amount<br>‚Ä¢ 50 = adds $50 to price<br>‚Ä¢ -20 = subtracts $20 from price<br>‚Ä¢ Example: Aluminum Frame = 50.00<br><br><strong>For Percentage:</strong><br>‚Ä¢ Enter percentage as number<br>‚Ä¢ 15 = adds 15% to current price<br>‚Ä¢ -10 = subtracts 10% from price<br>‚Ä¢ Example: Premium Finish = 15<br><br><strong>For Formula:</strong><br>‚Ä¢ Leave empty, use Price Formula instead<br><br><strong>Tip:</strong> Use negative values for discounts or cost reductions">!</span>
                            </label>
                            <input type="number" 
                                   name="price_impact_value" 
                                   value="{{ form_data.price_impact_value if form_data and form_data.price_impact_value is not none else (node.price_impact_value if node and node.price_impact_value else '') }}"
                                   step="0.01"
                                   placeholder="0.00">
                            <div class="field-help">Dollar amount or percentage (e.g., 50 or 10)</div>
                        </div>
                    </div>

                    <div class="form-field">
                        <label>
                            Price Formula
                            <span class="tooltip-icon" data-tippy-content="Dynamic formula for calculating price impact. Only used when Price Impact Type is 'Formula'.<br><br><strong>Available Variables:</strong><br>‚Ä¢ width, height, depth - dimensions<br>‚Ä¢ base_price - current base price<br>‚Ä¢ quantity - order quantity<br>‚Ä¢ area - calculated area (width * height)<br><br><strong>Examples:</strong><br>‚Ä¢ 'width * height * 0.05' - $0.05 per sq inch<br>‚Ä¢ '(width + height) * 2 * 3.50' - perimeter pricing<br>‚Ä¢ 'base_price * 0.15' - 15% of base<br>‚Ä¢ 'area > 1000 ? 500 : 300' - conditional pricing<br><br><strong>Operators:</strong> +, -, *, /, >, <, ==, ?, :<br><br><strong>Safety:</strong> Formulas are validated before execution">!</span>
                        </label>
                        <textarea name="price_formula" 
                                  rows="2"
                                  placeholder="e.g., width * height * 0.05">{{ form_data.price_formula if form_data and form_data.price_formula else (node.price_formula if node and node.price_formula else '') }}</textarea>
                        <div class="field-help">Dynamic pricing calculation (use variables like width, height)</div>
                    </div>
                </div>
            </div>

            <!-- Weight Configuration -->
            <div class="form-section-card">
                <div class="section-header">
                    <div class="section-header-icon">‚öñÔ∏è</div>
                    <div>
                        <h5>Weight Configuration</h5>
                        <div class="section-header-description">Physical weight impact</div>
                    </div>
                </div>
                <div class="section-content">
                    <div class="field-grid field-grid-2">
                        <div class="form-field">
                            <label>
                                Weight Impact (kg)
                                <span class="tooltip-icon" data-tippy-content="Fixed weight added to the product when this option is selected. Measured in kilograms.<br><br><strong>Effects:</strong><br>‚Ä¢ Added to total product weight<br>‚Ä¢ Used for shipping calculations<br>‚Ä¢ Affects freight costs<br>‚Ä¢ Important for logistics planning<br><br><strong>Examples:</strong><br>‚Ä¢ Aluminum Frame: 2.5 kg<br>‚Ä¢ Triple Pane Glass: 8.0 kg<br>‚Ä¢ Premium Hardware: 1.2 kg<br>‚Ä¢ Lightweight Option: -0.5 kg (reduction)<br><br><strong>Tip:</strong> Use negative values for weight-reducing options">!</span>
                            </label>
                            <input type="number" 
                                   name="weight_impact" 
                                   value="{{ form_data.weight_impact if form_data and form_data.weight_impact is not none else (node.weight_impact if node and node.weight_impact else '0') }}"
                                   step="0.01"
                                   placeholder="0.00">
                            <div class="field-help">Fixed weight in kilograms</div>
                        </div>

                        <div class="form-field">
                            <label>
                                Weight Formula
                                <span class="tooltip-icon" data-tippy-content="Dynamic formula for calculating weight based on dimensions or other factors.<br><br><strong>Available Variables:</strong><br>‚Ä¢ width, height, depth - dimensions<br>‚Ä¢ area - width * height<br>‚Ä¢ volume - width * height * depth<br>‚Ä¢ base_weight - base product weight<br><br><strong>Examples:</strong><br>‚Ä¢ 'area * 0.02' - 0.02 kg per sq inch<br>‚Ä¢ 'width * height * depth * 0.001' - volume-based<br>‚Ä¢ '(width + height) * 0.05' - perimeter-based<br>‚Ä¢ 'area > 1000 ? 15 : 10' - conditional weight<br><br><strong>Use Cases:</strong><br>‚Ä¢ Glass weight (area-based)<br>‚Ä¢ Frame weight (perimeter-based)<br>‚Ä¢ Material density calculations">!</span>
                            </label>
                            <textarea name="weight_formula" 
                                      rows="2"
                                      placeholder="e.g., area * 0.02">{{ form_data.weight_formula if form_data and form_data.weight_formula else (node.weight_formula if node and node.weight_formula else '') }}</textarea>
                            <div class="field-help">Dynamic weight calculation</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Technical Properties -->
            <div class="form-section-card">
                <div class="section-header">
                    <div class="section-header-icon">üî¨</div>
                    <div>
                        <h5>Technical Properties</h5>
                        <div class="section-header-description">Technical specifications and calculations</div>
                    </div>
                </div>
                <div class="section-content">
                    <div class="form-field">
                        <label>
                            Technical Property Type
                            <span class="tooltip-icon" data-tippy-content="Identifier for product-specific technical specifications. Used to categorize calculated technical data.<br><br><strong>Window Examples:</strong><br>‚Ä¢ 'u_value' - Thermal insulation (lower is better)<br>‚Ä¢ 'shgc' - Solar heat gain coefficient<br>‚Ä¢ 'vt' - Visible transmittance<br>‚Ä¢ 'air_infiltration' - Air leakage rating<br>‚Ä¢ 'water_resistance' - Water penetration rating<br><br><strong>Door Examples:</strong><br>‚Ä¢ 'fire_rating' - Fire resistance time<br>‚Ä¢ 'security_rating' - Break-in resistance<br>‚Ä¢ 'sound_transmission' - Noise reduction<br><br><strong>Furniture Examples:</strong><br>‚Ä¢ 'load_capacity' - Maximum weight<br>‚Ä¢ 'surface_hardness' - Durability rating<br><br><strong>Storage:</strong> Stored in calculated_technical_data JSONB field">!</span>
                        </label>
                        <input type="text" 
                               name="technical_property_type" 
                               value="{{ form_data.technical_property_type if form_data and form_data.technical_property_type else (node.technical_property_type if node and node.technical_property_type else '') }}"
                               placeholder="e.g., u_value, load_capacity, thermal_resistance">
                        <div class="field-help">Identifier for technical specifications</div>
                    </div>

                    <div class="form-field">
                        <label>
                            Technical Impact Formula
                            <span class="tooltip-icon" data-tippy-content="Formula for calculating technical specifications. Results stored in calculated_technical_data.<br><br><strong>U-Value Example (Thermal Insulation):</strong><br>‚Ä¢ '1 / (r_value + 0.5)' - Lower is better<br>‚Ä¢ Double Pane: r_value = 3.0 ‚Üí U = 0.29<br>‚Ä¢ Triple Pane: r_value = 5.0 ‚Üí U = 0.18<br><br><strong>Load Capacity Example:</strong><br>‚Ä¢ 'base_capacity * thickness_factor'<br>‚Ä¢ Thicker material = higher capacity<br><br><strong>SHGC Example (Solar Heat Gain):</strong><br>‚Ä¢ '0.7 - (coating_layers * 0.15)'<br>‚Ä¢ More coatings = less heat gain<br><br><strong>Available Variables:</strong><br>‚Ä¢ Any numeric attribute from configuration<br>‚Ä¢ Material properties (thickness, density)<br>‚Ä¢ Constants for calculations<br><br><strong>Result:</strong> Aggregated into configuration's technical_data">!</span>
                        </label>
                        <textarea name="technical_impact_formula" 
                                  rows="3"
                                  placeholder="e.g., 1 / (thickness * 0.04)">{{ form_data.technical_impact_formula if form_data and form_data.technical_impact_formula else (node.technical_impact_formula if node and node.technical_impact_formula else '') }}</textarea>
                        <div class="field-help">Formula for calculating technical specifications</div>
                    </div>
                </div>
            </div>

            <!-- UI Configuration -->
            <div class="form-section-card">
                <div class="section-header">
                    <div class="section-header-icon">üé®</div>
                    <div>
                        <h5>User Interface</h5>
                        <div class="section-header-description">How users interact with this attribute</div>
                    </div>
                </div>
                <div class="section-content">
                    <div class="form-field">
                        <label>
                            UI Component
                            <span class="tooltip-icon" data-tippy-content="The user interface control displayed for this attribute:<br><br><strong>Dropdown Menu:</strong><br>‚Ä¢ Best for 5+ options<br>‚Ä¢ Saves screen space<br>‚Ä¢ Example: Color selection (20 colors)<br><br><strong>Radio Buttons:</strong><br>‚Ä¢ Best for 2-5 options<br>‚Ä¢ All options visible<br>‚Ä¢ Example: Frame Material (Aluminum, Wood, Vinyl)<br><br><strong>Checkboxes:</strong><br>‚Ä¢ For multiple selections<br>‚Ä¢ Independent choices<br>‚Ä¢ Example: Optional features (Energy Star, UV Protection)<br><br><strong>Slider:</strong><br>‚Ä¢ For numeric ranges<br>‚Ä¢ Visual feedback<br>‚Ä¢ Example: Dimensions (24-96 inches)<br><br><strong>Text Input:</strong><br>‚Ä¢ For free-form entry<br>‚Ä¢ Custom values<br>‚Ä¢ Example: Custom dimensions, notes">!</span>
                        </label>
                        <select name="ui_component">
                            <option value="">-- Select Component --</option>
                            <option value="dropdown" 
                                    {% if (form_data and form_data.ui_component == 'dropdown') or (node and node.ui_component == 'dropdown') %}selected{% endif %}>
                                Dropdown - Select from list
                            </option>
                            <option value="radio" 
                                    {% if (form_data and form_data.ui_component == 'radio') or (node and node.ui_component == 'radio') %}selected{% endif %}>
                                Radio - Single choice buttons
                            </option>
                            <option value="checkbox" 
                                    {% if (form_data and form_data.ui_component == 'checkbox') or (node and node.ui_component == 'checkbox') %}selected{% endif %}>
                                Checkbox - Multiple selections
                            </option>
                            <option value="slider" 
                                    {% if (form_data and form_data.ui_component == 'slider') or (node and node.ui_component == 'slider') %}selected{% endif %}>
                                Slider - Range selection
                            </option>
                            <option value="input" 
                                    {% if (form_data and form_data.ui_component == 'input') or (node and node.ui_component == 'input') %}selected{% endif %}>
                                Input - Text/number entry
                            </option>
                        </select>
                        <div class="field-help">Control type shown to users</div>
                    </div>

                    <div class="form-field">
                        <label>
                            Description
                            <span class="tooltip-icon" data-tippy-content="User-facing description displayed during product configuration. Should be clear, helpful, and customer-friendly.<br><br><strong>Good Examples:</strong><br>‚Ä¢ 'Choose the frame material for your window. Aluminum is durable and low-maintenance, while wood offers classic beauty.'<br>‚Ä¢ 'Select glass type based on your energy efficiency needs. Triple pane provides maximum insulation.'<br>‚Ä¢ 'Enter the width of your window opening in inches.'<br><br><strong>Tips:</strong><br>‚Ä¢ Write for customers, not technical staff<br>‚Ä¢ Explain benefits, not just features<br>‚Ä¢ Keep it concise (2-3 sentences max)<br>‚Ä¢ Avoid jargon unless necessary<br><br><strong>Displayed:</strong> Near the attribute in configuration UI">!</span>
                        </label>
                        <textarea name="description" 
                                  rows="3"
                                  style="font-family: inherit;"
                                  placeholder="User-friendly description of this attribute">{{ form_data.description if form_data and form_data.description else (node.description if node and node.description else '') }}</textarea>
                        <div class="field-help">Shown to users when configuring products</div>
                    </div>

                    <div class="form-field">
                        <label>
                            Help Text
                            <span class="tooltip-icon" data-tippy-content="Additional guidance shown as a tooltip or help icon. Use for extra tips, warnings, or clarifications.<br><br><strong>Good Examples:</strong><br>‚Ä¢ 'Aluminum is best for coastal areas due to corrosion resistance.'<br>‚Ä¢ 'Measure the rough opening, not the existing window.'<br>‚Ä¢ 'Triple pane adds significant weight - ensure proper support.'<br>‚Ä¢ 'This option may extend lead time by 2 weeks.'<br><br><strong>Use For:</strong><br>‚Ä¢ Technical tips<br>‚Ä¢ Measurement instructions<br>‚Ä¢ Material recommendations<br>‚Ä¢ Lead time warnings<br>‚Ä¢ Installation considerations<br><br><strong>Displayed:</strong> As tooltip (?) icon or expandable help section">!</span>
                        </label>
                        <textarea name="help_text" 
                                  rows="2"
                                  style="font-family: inherit;"
                                  placeholder="Additional guidance or tips">{{ form_data.help_text if form_data and form_data.help_text else (node.help_text if node and node.help_text else '') }}</textarea>
                        <div class="field-help">Extra help for users (optional)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sticky Action Buttons -->
        <div class="form-actions-sticky">
            <a href="/api/v1/admin/hierarchy?manufacturing_type_id={{ manufacturing_type.id }}" 
               class="btn-enhanced btn-secondary-enhanced">
                ‚Üê Cancel
            </a>
            <button type="submit" class="btn-enhanced btn-primary-enhanced">
                {% if node %}
                üíæ Update Node
                {% else %}
                ‚ú® Create Node
                {% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy-bundle.umd.min.js"></script>
<script>
    // Initialize tooltips
    document.addEventListener('DOMContentLoaded', function() {
        tippy('.tooltip-icon', {
            theme: 'custom',
            placement: 'top',
            arrow: true,
            animation: 'scale',
            duration: [200, 150],
            maxWidth: 400,
            interactive: false,
            allowHTML: true,  // ‚Üê Enable HTML in tooltip content
            appendTo: document.body  // ‚Üê Append to body to avoid z-index issues
        });
        
        // Visual indentation for parent nodes
        const parentSelect = document.getElementById('parent_node_id');
        if (parentSelect) {
            const options = parentSelect.querySelectorAll('option[data-depth]');
            options.forEach(option => {
                const depth = parseInt(option.getAttribute('data-depth'));
                if (depth > 0) {
                    option.style.paddingLeft = (depth * 20 + 10) + 'px';
                }
            });
        }
    });
    
    // Form validation
    document.getElementById('nodeForm').addEventListener('submit', function(e) {
        const name = document.querySelector('[name="name"]').value.trim();
        const nodeType = document.querySelector('[name="node_type"]').value;
        
        if (!name) {
            e.preventDefault();
            alert('Node name is required');
            return false;
        }
        
        if (!nodeType) {
            e.preventDefault();
            alert('Node type is required');
            return false;
        }
        
        // Show loading state
        document.querySelector('.form-container').classList.add('loading');
    });
</script>
{% endblock %}