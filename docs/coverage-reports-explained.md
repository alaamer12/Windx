# Coverage Reports in CI/CD - Complete Guide

## Where Do Coverage Reports Go?

Coverage reports in your CI/CD workflows go to **three different places**:

### 1. ğŸ“Š Codecov.io (External Service)
**Location**: https://codecov.io/gh/YOUR_USERNAME/YOUR_REPO

**How it works**:
```yaml
- name: Upload coverage to Codecov
  uses: codecov/codecov-action@v4
  if: always()
  with:
    file: ./coverage.xml          # â† Generated coverage file
    flags: unittests              # â† Tag for this report
    name: codecov-umbrella        # â† Display name
    fail_ci_if_error: false       # â† Don't fail if upload fails
  env:
    CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
```

**What you get**:
- ğŸ“ˆ Coverage trends over time
- ğŸ“‰ Coverage diff on pull requests
- ğŸ¯ Line-by-line coverage visualization
- ğŸ“Š Coverage badges for README
- ğŸ”” Notifications for coverage drops

**Setup Required**:
1. Sign up at https://codecov.io
2. Connect your GitHub repository
3. Add `CODECOV_TOKEN` to GitHub Secrets
4. Coverage reports automatically upload on each push

**Example Badge**:
```markdown
[![codecov](https://codecov.io/gh/username/repo/branch/main/graph/badge.svg)](https://codecov.io/gh/username/repo)
```

---

### 2. ğŸ“ GitHub Actions Summary (In-Workflow)
**Location**: GitHub Actions run page â†’ Summary tab

**How it works**:
```yaml
- name: Test Summary
  if: always()
  run: |
    echo "## ğŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
    echo "" >> $GITHUB_STEP_SUMMARY
    if [ "${{ job.status }}" == "success" ]; then
      echo "âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "**Coverage:** ${{ env.COVERAGE }}" >> $GITHUB_STEP_SUMMARY
    else
      echo "âŒ Tests failed. Check the logs for details." >> $GITHUB_STEP_SUMMARY
    fi
```

**What you get**:
- âœ… Quick pass/fail status
- ğŸ“Š Coverage percentage
- ğŸ“ Formatted markdown summary
- ğŸ”— Visible on workflow run page

**Example Output**:
```
## ğŸ“Š Test Results

âœ… All tests passed!

**Coverage:** 44%
```

**Where to find it**:
1. Go to GitHub repository
2. Click "Actions" tab
3. Click on a workflow run
4. See "Summary" at the top of the page

---

### 3. ğŸ’» Terminal Output (During Test Run)
**Location**: GitHub Actions logs (visible during run)

**How it works**:
```yaml
- name: Run tests with coverage
  run: uv run pytest tests/ -v --tb=short --cov=app --cov-report=xml --cov-report=term -m "not e2e and not redis"
  #                                                   â†‘ XML file      â†‘ Terminal output
```

**What you get**:
```
Name                                          Stmts   Miss  Cover   Missing
---------------------------------------------------------------------------
app/__init__.py                                   1      0   100%
app/api/__init__.py                               1      0   100%
app/api/admin_utils.py                           36     20    44%   67-74, 121-127
app/api/deps.py                                  50     34    32%   57-122, 139-144
...
---------------------------------------------------------------------------
TOTAL                                          5126   2869    44%
```

**Where to find it**:
1. Go to GitHub repository
2. Click "Actions" tab
3. Click on a workflow run
4. Click on the job (e.g., "test")
5. Expand the "Run tests with coverage" step
6. Scroll through the logs

---

## Coverage Report Files Generated

### 1. `coverage.xml` (XML Format)
**Purpose**: Machine-readable format for Codecov and other tools

**Generated by**: `--cov-report=xml`

**Location**: 
- **Local**: `./coverage.xml` (in project root)
- **CI/CD**: Temporary file in runner workspace

**Content Example**:
```xml
<?xml version="1.0" ?>
<coverage version="7.0.0" timestamp="1234567890">
  <packages>
    <package name="app" line-rate="0.44" branch-rate="0.0">
      <classes>
        <class name="__init__.py" filename="app/__init__.py" line-rate="1.0">
          <lines>
            <line number="1" hits="1"/>
          </lines>
        </class>
      </classes>
    </package>
  </packages>
</coverage>
```

**Used by**:
- Codecov upload action
- Coverage analysis tools
- CI/CD integrations

---

### 2. `htmlcov/` (HTML Report)
**Purpose**: Human-readable, interactive coverage report

**Generated by**: `--cov-report=html` (in pyproject.toml)

**Location**:
- **Local**: `./htmlcov/index.html`
- **CI/CD**: Not generated (would be discarded)

**What it contains**:
- `index.html` - Main coverage summary
- `*.html` - Per-file coverage with highlighted lines
- CSS/JS for interactive features

**How to view locally**:
```bash
# Run tests with coverage
uv run pytest tests/ --cov=app --cov-report=html

# Open in browser
open htmlcov/index.html  # macOS
start htmlcov/index.html  # Windows
xdg-open htmlcov/index.html  # Linux
```

**Features**:
- ğŸ¨ Color-coded coverage (green = covered, red = missed)
- ğŸ” Click on files to see line-by-line coverage
- ğŸ“Š Coverage percentages per module
- ğŸ”— Navigate through your codebase

**Example**:
```
Coverage Report
Total: 44%

app/
  __init__.py         100%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
  api/
    __init__.py       100%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    deps.py            32%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
    types.py           90%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘
```

---

### 3. Terminal Output (Text Format)
**Purpose**: Quick coverage summary in terminal

**Generated by**: `--cov-report=term`

**Location**: Stdout (terminal/logs)

**Example**:
```
---------- coverage: platform linux, python 3.11.14-final-0 ----------
Name                                          Stmts   Miss  Cover
-----------------------------------------------------------------
app/__init__.py                                   1      0   100%
app/api/__init__.py                               1      0   100%
app/api/admin_utils.py                           36     20    44%
app/api/deps.py                                  50     34    32%
-----------------------------------------------------------------
TOTAL                                          5126   2869    44%
```

---

## Your Current Workflows

### 1. `tests-with-coverage.yml`
**Coverage Destinations**:
1. âœ… Codecov.io (via upload action)
2. âœ… GitHub Actions Summary (via $GITHUB_STEP_SUMMARY)
3. âœ… Terminal output (via --cov-report=term)

**Files Generated**:
- `coverage.xml` â†’ Uploaded to Codecov
- Terminal output â†’ Visible in logs

---

### 2. `redis-tests.yml`
**Coverage Destinations**:
1. âœ… Codecov.io (with flag: `redis-tests`)
2. âœ… GitHub Actions Summary
3. âœ… Terminal output

**Files Generated**:
- `coverage.xml` â†’ Uploaded to Codecov with `redis` flag
- Terminal output â†’ Visible in logs

---

### 3. `e2e-tests.yml`
**Coverage Destinations**:
1. âœ… Codecov.io (with flag: `e2e`)
2. âœ… GitHub Actions Summary
3. âœ… Terminal output

**Files Generated**:
- `coverage.xml` â†’ Uploaded to Codecov with `e2e` flag
- Terminal output â†’ Visible in logs

---

## Coverage Flags Explained

Your workflows use **flags** to separate different types of coverage:

```yaml
# Regular tests
flags: unittests

# Redis tests
flags: redis-tests

# E2E tests
flags: e2e
```

**Why use flags?**
- ğŸ“Š See coverage breakdown by test type
- ğŸ¯ Track coverage trends separately
- ğŸ” Identify which tests cover which code
- ğŸ“ˆ Compare coverage across test suites

**In Codecov**:
- View overall coverage: All flags combined
- View by flag: Filter by `unittests`, `redis-tests`, or `e2e`
- Compare flags: See which test type covers what

---

## Local Coverage Reports

When you run tests locally, coverage reports go to:

### 1. Terminal Output
```bash
uv run pytest tests/ --cov=app --cov-report=term
# Shows coverage in terminal immediately
```

### 2. HTML Report
```bash
uv run pytest tests/ --cov=app --cov-report=html
# Creates htmlcov/ directory
# Open htmlcov/index.html in browser
```

### 3. XML Report
```bash
uv run pytest tests/ --cov=app --cov-report=xml
# Creates coverage.xml file
# Used by IDEs and tools
```

### 4. All at Once (Default in pyproject.toml)
```bash
uv run pytest tests/
# Generates all three:
# - Terminal output
# - htmlcov/
# - coverage.xml
```

---

## Coverage Report Lifecycle

### In CI/CD:
```
1. Tests run with coverage
   â†“
2. coverage.xml generated
   â†“
3. Terminal output shown in logs
   â†“
4. coverage.xml uploaded to Codecov
   â†“
5. Summary written to $GITHUB_STEP_SUMMARY
   â†“
6. Workflow completes
   â†“
7. Temporary files deleted by GitHub
   â†“
8. Coverage persists on Codecov.io
```

### Locally:
```
1. Tests run with coverage
   â†“
2. Reports generated:
   - coverage.xml
   - htmlcov/
   - Terminal output
   â†“
3. Files persist in your project
   â†“
4. .gitignore prevents committing them
   â†“
5. You can view htmlcov/index.html anytime
```

---

## Viewing Coverage Reports

### Option 1: Codecov.io (Recommended)
1. Go to https://codecov.io
2. Sign in with GitHub
3. Find your repository
4. View coverage dashboard

**Features**:
- ğŸ“ˆ Coverage trends
- ğŸ“Š Pull request coverage diff
- ğŸ¯ File-by-file coverage
- ğŸ”” Notifications

### Option 2: GitHub Actions Summary
1. Go to repository â†’ Actions
2. Click on a workflow run
3. View Summary tab

**Features**:
- âœ… Quick pass/fail status
- ğŸ“Š Coverage percentage
- ğŸ“ Test summary

### Option 3: Local HTML Report
1. Run: `uv run pytest tests/ --cov=app --cov-report=html`
2. Open: `htmlcov/index.html`

**Features**:
- ğŸ¨ Interactive coverage visualization
- ğŸ” Line-by-line coverage
- ğŸ“Š Module-level breakdown

### Option 4: IDE Integration
Many IDEs can show coverage inline:

**VS Code**:
- Install "Coverage Gutters" extension
- Run tests with coverage
- See coverage in editor gutter

**PyCharm**:
- Run â†’ Run with Coverage
- See coverage inline in editor

---

## Coverage Configuration

### In `pyproject.toml`:
```toml
[tool.pytest.ini_options]
addopts = [
    "-v",
    "-l",
    "-ra",
    "--strict-markers",
    "-W", "default",
    "--cov=app",              # â† Measure coverage for app/
    "--cov-report=html",      # â† Generate HTML report
    "--cov-report=term-missing",  # â† Show missing lines in terminal
]
```

### In Workflows:
```yaml
# Generate XML for Codecov + terminal output
--cov=app --cov-report=xml --cov-report=term
```

---

## Common Questions

### Q: Why don't I see htmlcov/ in CI/CD?
**A**: HTML reports aren't generated in CI/CD because:
- They're not needed (Codecov provides better visualization)
- They take up space
- They'd be deleted after workflow completes anyway

### Q: Where is coverage.xml after workflow completes?
**A**: It's deleted by GitHub Actions after the workflow completes. The data is preserved on Codecov.io.

### Q: Can I download coverage reports from CI/CD?
**A**: Not by default, but you can add an artifact upload step:

```yaml
- name: Upload coverage artifact
  uses: actions/upload-artifact@v4
  with:
    name: coverage-report
    path: htmlcov/
    retention-days: 7
```

### Q: How do I see coverage for a specific pull request?
**A**: 
1. Go to Codecov.io
2. Navigate to your repository
3. Click on "Pull Requests"
4. Select your PR
5. See coverage diff (lines added/removed/changed)

### Q: Why is coverage different locally vs CI/CD?
**A**: Possible reasons:
- Different test markers (`-m "not e2e and not redis"`)
- Different environment (Redis available/unavailable)
- Different Python version
- Different dependencies

---

## Summary

**Coverage reports go to**:
1. ğŸŒ **Codecov.io** - Persistent, feature-rich, shareable
2. ğŸ“ **GitHub Actions Summary** - Quick overview in workflow
3. ğŸ’» **Terminal Logs** - Detailed output during run
4. ğŸ“ **Local Files** - htmlcov/ and coverage.xml (local only)

**Best practices**:
- âœ… Use Codecov for long-term tracking
- âœ… Check GitHub Summary for quick status
- âœ… View HTML report locally for detailed analysis
- âœ… Use flags to separate test types
- âœ… Set coverage thresholds in Codecov

Your current setup is excellent and follows industry best practices! ğŸš€
