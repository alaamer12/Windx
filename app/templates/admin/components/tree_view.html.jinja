{# Recursive macro for rendering tree nodes #}
{% macro render_tree_node(node, level=0) %}
<li class="tree-node" data-node-id="{{ node.id }}" data-level="{{ level }}">
    <div class="node-content">
        <div class="node-info">
            <!-- Toggle button for nodes with children -->
            {% if node.children %}
            <button class="toggle-btn" type="button" onclick="toggleNode(this)">
                ‚ñº
            </button>
            {% else %}
            <span class="toggle-placeholder"></span>
            {% endif %}
            
            <!-- Node icon based on type -->
            <span class="node-icon">
                {% if node.node_type == 'category' %}üìÅ
                {% elif node.node_type == 'attribute' %}‚öôÔ∏è
                {% elif node.node_type == 'option' %}üîò
                {% elif node.node_type == 'component' %}üß©
                {% elif node.node_type == 'technical_spec' %}üìè
                {% else %}‚ö™
                {% endif %}
            </span>
            
            <!-- Node name -->
            <strong class="node-name">{{ node.name }}</strong>
            
            <!-- Node type badge -->
            <span class="badge badge-{{ node.node_type }}">
                {{ node.node_type }}
            </span>
            
            <!-- Price impact -->
            {% if node.price_impact_value %}
            <span class="badge badge-price">
                {% if node.price_impact_value > 0 %}+{% endif %}${{ "%.2f"|format(node.price_impact_value) }}
            </span>
            {% endif %}
            
            <!-- Weight impact -->
            {% if node.weight_impact and node.weight_impact != 0 %}
            <span class="badge badge-weight">
                {% if node.weight_impact > 0 %}+{% endif %}{{ "%.2f"|format(node.weight_impact) }}kg
            </span>
            {% endif %}
            
            <!-- Path info (small) -->
            <small class="node-path">
                {{ node.ltree_path }}
            </small>
        </div>
        
        <!-- Action buttons -->
        <div class="node-actions">
            <a href="/api/v1/admin/hierarchy/node/create?manufacturing_type_id={{ node.manufacturing_type_id }}&parent_id={{ node.id }}" 
               class="action-btn btn-add" 
               title="Add Child Node">+</a>
            <a href="/api/v1/admin/hierarchy/node/{{ node.id }}/edit" 
               class="action-btn btn-edit" 
               title="Edit Node">‚úé</a>
            <form method="POST" 
                  action="/api/v1/admin/hierarchy/node/{{ node.id }}/delete" 
                  style="display: inline;"
                  onsubmit="return confirm('Are you sure you want to delete this node? {% if node.children %}This will also delete all child nodes.{% endif %}');">
                <button type="submit" 
                        class="action-btn btn-delete" 
                        title="Delete Node">√ó</button>
            </form>
        </div>
    </div>
    
    <!-- Render children recursively -->
    {% if node.children %}
    <ul class="tree-children">
        {% for child in node.children %}
            {{ render_tree_node(child, level + 1) }}
        {% endfor %}
    </ul>
    {% endif %}
</li>
{% endmacro %}

{# Main tree rendering #}
<style>
    .tree-root {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .tree-node {
        list-style: none;
        margin-bottom: 0.25rem;
    }
    
    .node-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem;
        background: white;
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        transition: all 0.2s ease;
    }
    
    .node-content:hover {
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border-color: var(--primary);
    }
    
    .node-info {
        display: flex;
        align-items: center;
        flex-grow: 1;
        gap: 0.5rem;
    }
    
    .toggle-btn {
        background: none;
        border: none;
        color: var(--text-light);
        cursor: pointer;
        font-size: 0.75rem;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
    }

    .toggle-btn.collapsed {
        transform: rotate(-90deg);
    }
    
    .toggle-placeholder {
        width: 24px;
        display: inline-block;
    }

    .node-icon {
        font-size: 1.1rem;
    }
    
    .node-name {
        color: var(--text);
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.15rem 0.5rem;
        border-radius: 1rem;
        font-weight: 500;
    }

    .badge-category { background: #dbeafe; color: #1e40af; }
    .badge-attribute { background: #e0f2fe; color: #0369a1; }
    .badge-option { background: #dcfce7; color: #15803d; }
    .badge-component { background: #fef3c7; color: #b45309; }
    .badge-technical_spec { background: #f1f5f9; color: #475569; }
    
    .badge-price { background: #fee2e2; color: #991b1b; }
    .badge-weight { background: #e0e7ff; color: #3730a3; }

    .node-path {
        color: var(--text-light);
        font-size: 0.75rem;
        margin-left: auto;
        margin-right: 1rem;
        font-family: monospace;
    }

    .node-actions {
        display: flex;
        gap: 0.25rem;
    }

    .action-btn {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--border);
        background: white;
        border-radius: 0.25rem;
        color: var(--text-light);
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1rem;
        line-height: 1;
    }

    .action-btn:hover {
        background: #f8fafc;
        color: var(--primary);
        border-color: var(--primary);
    }

    .btn-add:hover { color: var(--success); border-color: var(--success); }
    .btn-delete:hover { color: var(--error); border-color: var(--error); }

    .tree-children {
        margin-top: 0.25rem;
        padding-left: 1.5rem;
        border-left: 1px solid #e2e8f0;
        margin-left: 0.75rem;
    }
    
    .tree-children.collapsed {
        display: none;
    }
</style>

<ul class="tree-root">
    {% for node in tree_nodes %}
        {{ render_tree_node(node) }}
    {% endfor %}
</ul>

<script>
    function toggleNode(button) {
        const nodeContent = button.closest('.node-content');
        const treeNode = nodeContent.closest('.tree-node');
        const children = treeNode.querySelector('.tree-children');
        
        if (children) {
            children.classList.toggle('collapsed');
            button.classList.toggle('collapsed');
        }
    }
    
    // Collapse all nodes by default except root level
    document.addEventListener('DOMContentLoaded', function() {
        const allNodes = document.querySelectorAll('.tree-node[data-level]');
        allNodes.forEach(function(node) {
            const level = parseInt(node.getAttribute('data-level'));
            if (level > 1) {
                const children = node.querySelector('.tree-children');
                const toggleBtn = node.querySelector('.toggle-btn');
                if (children && toggleBtn) {
                    children.classList.add('collapsed');
                    toggleBtn.classList.add('collapsed');
                }
            }
        });
    });
</script>
