{% extends "admin/base.html.jinja" %}

{% import "components/rbac_helpers.html.jinja" as rbac with context %}
{% import "components/tables.html.jinja" as tables with context %}

{% block title %}Manufacturing Types - WindX Admin{% endblock %}

{% set active_page = "manufacturing" %}

{% block extra_css %}
<style>
    .truncate-text {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: help;
        color: var(--text-light);
    }
</style>
{% endblock %}

{% block content %}
{# Use RBAC-aware page header macro #}
{{ rbac.rbac_page_header(
    "Manufacturing Types",
    subtitle="Manage product categories and base configurations",
    actions=page_actions if page_actions else []
) }}

<div class="card">
    {% if manufacturing_types %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 1px solid var(--border); text-align: left;">
                <th style="padding: 1rem; font-weight: 600; color: var(--text-light);">Name</th>
                <th style="padding: 1rem; font-weight: 600; color: var(--text-light);">Category</th>
                <th style="padding: 1rem; font-weight: 600; color: var(--text-light);">Description</th>
                <th style="padding: 1rem; font-weight: 600; color: var(--text-light);">Base Price</th>
                <th style="padding: 1rem; font-weight: 600; color: var(--text-light);">Status</th>
                <th style="padding: 1rem; font-weight: 600; color: var(--text-light); text-align: right;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for type in manufacturing_types %}
            <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 1rem; font-weight: 500;">{{ type.name }}</td>
                <td style="padding: 1rem;">{{ type.base_category or type.category or '-' }}</td>
                <td style="padding: 1rem;">
                    <div class="truncate-text" title="{{ type.description or '' }}">
                        {{ type.description or '-' }}
                    </div>
                </td>
                <td style="padding: 1rem;">${{ "%.2f"|format(type.base_price) }}</td>
                <td style="padding: 1rem;">
                    {# Use status badge macro #}
                    {{ tables.status_badge("active" if type.is_active else "inactive", type="success" if type.is_active else "info") }}
                </td>
                <td style="padding: 1rem; text-align: right;">
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        {# RBAC-aware action buttons #}
                        {% if can('manufacturing_type:update') %}
                            <a href="/api/v1/admin/manufacturing-types/{{ type.id }}/edit" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Edit</a>
                        {% endif %}
                        {% if can('attribute_node:read') %}
                            <a href="/api/v1/admin/hierarchy?manufacturing_type_id={{ type.id }}" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Hierarchy</a>
                        {% endif %}
                        {% if can('manufacturing_type:delete') %}
                            <button type="button" class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;" onclick="confirmDelete({{ type.id }}, '{{ type.name }}')">Delete</button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    {# Use empty state macro with RBAC-aware action button #}
    {{ tables.empty_state(
        icon="üè≠",
        title="No Manufacturing Types",
        message="Create your first product type to get started.",
        action_text="Create First Type",
        action_href="/api/v1/admin/manufacturing-types/create",
        action_permission="manufacturing_type:create"
    ) }}
    {% endif %}
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
        <div class="modal-content" style="background-color: #fefefe; margin: auto; padding: 2rem; border: 1px solid #888; width: 100%; max-width: 500px; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
            <h2 style="margin-bottom: 1rem; color: var(--text);">Confirm Deletion</h2>
            <p style="margin-bottom: 1.5rem; color: var(--text-light);">Are you sure you want to delete <strong id="deleteItemName"></strong>? This action cannot be undone and will delete all associated attribute hierarchies and configurations.</p>
            
            <form id="deleteForm" method="POST" action="">
                <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button type="button" class="btn btn-outline" onclick="closeDeleteModal()">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Permanently</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function confirmDelete(id, name) {
        const modal = document.getElementById('deleteModal');
        const form = document.getElementById('deleteForm');
        const nameSpan = document.getElementById('deleteItemName');
        
        form.action = `/api/v1/admin/manufacturing-types/${id}/delete`;
        nameSpan.textContent = name;
        
        modal.style.display = "flex";
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = "none";
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('deleteModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
{% endblock %}
