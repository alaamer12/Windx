{# 
  EXAMPLE USAGE - RBAC Template Components
  
  This file demonstrates how to use the RBAC component library
  in a typical admin page template.
#}

{% extends "admin/base.html.jinja" %}

{# Import the macros you need #}
{% from "components/rbac_helpers.html.jinja" import rbac_page_header, rbac_button, protected_content %}
{% from "components/tables.html.jinja" import rbac_table_actions, rbac_table_header, empty_state, status_badge %}

{% block title %}Example Page - WindX Admin{% endblock %}

{# Set the active page for sidebar highlighting #}
{% set active_page = "customers" %}

{% block content %}

{# ============================================
   EXAMPLE 1: Page Header with Actions
   ============================================ #}

{{ rbac_page_header(
  "Customer Management",
  subtitle="View and manage customer accounts",
  actions=[
    {
      "text": "New Customer",
      "href": "/api/v1/admin/customers/create",
      "permission": "customer:create",
      "icon": "‚ûï",
      "class": "btn btn-primary"
    },
    {
      "text": "Import Customers",
      "href": "/api/v1/admin/customers/import",
      "permission": "customer:create",
      "icon": "üì•",
      "class": "btn btn-outline"
    },
    {
      "text": "Export",
      "href": "/api/v1/admin/customers/export",
      "permission": "customer:read",
      "icon": "üì§",
      "class": "btn btn-outline"
    }
  ]
) }}

{# ============================================
   EXAMPLE 2: Protected Content Block
   ============================================ #}

{% call protected_content(role="SUPERADMIN", fallback_message="Only administrators can view this section") %}
  <div class="card" style="margin-bottom: 1rem; background: #fef3c7; border: 1px solid #fbbf24;">
    <div style="padding: 1rem;">
      <h3 style="margin: 0 0 0.5rem 0; color: #92400e;">‚ö†Ô∏è Admin Only Section</h3>
      <p style="margin: 0; color: #92400e;">This content is only visible to SUPERADMIN users.</p>
    </div>
  </div>
{% endcall %}

{# ============================================
   EXAMPLE 3: Data Table with RBAC Actions
   ============================================ #}

<div class="card">
  {% if customers %}
    <table style="width: 100%; border-collapse: collapse;">
      {# Table header with column definitions #}
      {{ rbac_table_header([
        {"label": "Name", "key": "name", "sortable": True},
        {"label": "Email", "key": "email", "sortable": True},
        {"label": "Company", "key": "company"},
        {"label": "Status", "align": "center"},
        {"label": "Created", "key": "created_at", "sortable": True},
        {"label": "Actions", "align": "right", "width": "200px"}
      ]) }}
      
      <tbody>
        {% for customer in customers %}
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 1rem; font-weight: 500;">{{ customer.full_name }}</td>
            <td style="padding: 1rem;">{{ customer.email }}</td>
            <td style="padding: 1rem;">{{ customer.company_name or '-' }}</td>
            <td style="padding: 1rem; text-align: center;">
              {# Status badge with conditional styling #}
              {% if customer.is_active %}
                {{ status_badge("active", type="success") }}
              {% else %}
                {{ status_badge("inactive", type="error") }}
              {% endif %}
            </td>
            <td style="padding: 1rem;">{{ customer.created_at.strftime('%Y-%m-%d') }}</td>
            <td style="padding: 1rem;">
              {# RBAC-filtered table actions #}
              {{ rbac_table_actions(customer, [
                {
                  "title": "View Details",
                  "icon": "üëÅÔ∏è",
                  "url": "/api/v1/admin/customers/{id}",
                  "permission": "customer:read",
                  "class": "btn btn-sm btn-outline"
                },
                {
                  "title": "Edit Customer",
                  "icon": "‚úèÔ∏è",
                  "url": "/api/v1/admin/customers/{id}/edit",
                  "permission": "customer:update",
                  "class": "btn btn-sm btn-outline"
                },
                {
                  "title": "View Orders",
                  "icon": "üì¶",
                  "url": "/api/v1/admin/customers/{id}/orders",
                  "permission": "order:read",
                  "class": "btn btn-sm btn-outline"
                },
                {
                  "title": "Delete Customer",
                  "icon": "üóëÔ∏è",
                  "url": "#",
                  "permission": "customer:delete",
                  "class": "btn btn-sm btn-danger",
                  "onclick": "confirmDelete({}, '{}')".format(customer.id, customer.full_name)
                }
              ]) }}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    {# Empty state when no data #}
    {{ empty_state(
      icon="üë•",
      title="No Customers Found",
      message="Get started by adding your first customer to the system.",
      action_text="Add First Customer",
      action_href="/api/v1/admin/customers/create",
      action_permission="customer:create"
    ) }}
  {% endif %}
</div>

{# ============================================
   EXAMPLE 4: Conditional Action Buttons
   ============================================ #}

<div class="card" style="margin-top: 1rem;">
  <div style="padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h3 style="margin: 0 0 0.5rem 0;">Bulk Actions</h3>
      <p style="margin: 0; color: var(--text-light); font-size: 0.875rem;">
        Select customers to perform bulk operations
      </p>
    </div>
    <div style="display: flex; gap: 0.5rem;">
      {# Individual RBAC buttons #}
      {{ rbac_button(
        "Export Selected",
        "#",
        permission="customer:read",
        class="btn btn-outline",
        icon="üì§",
        onclick="exportSelected()"
      ) }}
      
      {{ rbac_button(
        "Send Email",
        "#",
        permission="customer:update",
        class="btn btn-outline",
        icon="‚úâÔ∏è",
        onclick="sendBulkEmail()"
      ) }}
      
      {{ rbac_button(
        "Delete Selected",
        "#",
        permission="customer:delete",
        class="btn btn-danger",
        icon="üóëÔ∏è",
        onclick="deleteBulkCustomers()"
      ) }}
    </div>
  </div>
</div>

{# ============================================
   EXAMPLE 5: Role-Based UI Sections
   ============================================ #}

{# Only show advanced settings to SUPERADMIN #}
{% if has.role('SUPERADMIN') %}
  <div class="card" style="margin-top: 1rem;">
    <div style="padding: 1rem;">
      <h3 style="margin: 0 0 1rem 0;">‚öôÔ∏è Advanced Settings</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        {{ rbac_button("System Configuration", "/admin/config", role="SUPERADMIN", class="btn btn-outline") }}
        {{ rbac_button("User Management", "/admin/users", role="SUPERADMIN", class="btn btn-outline") }}
        {{ rbac_button("Audit Logs", "/admin/audit", role="SUPERADMIN", class="btn btn-outline") }}
        {{ rbac_button("Database Tools", "/admin/database", role="SUPERADMIN", class="btn btn-outline") }}
      </div>
    </div>
  </div>
{% endif %}

{# Show different content for different roles #}
{% if has.role('SALESMAN') %}
  <div class="card" style="margin-top: 1rem; background: #dbeafe; border: 1px solid #3b82f6;">
    <div style="padding: 1rem;">
      <h3 style="margin: 0 0 0.5rem 0; color: #1e40af;">üíº Sales Tools</h3>
      <p style="margin: 0 0 1rem 0; color: #1e40af;">Quick access to sales-related functions</p>
      <div style="display: flex; gap: 0.5rem;">
        {{ rbac_button("Generate Quote", "/quotes/new", permission="quote:create", class="btn btn-primary") }}
        {{ rbac_button("View Pipeline", "/sales/pipeline", permission="order:read", class="btn btn-outline") }}
      </div>
    </div>
  </div>
{% endif %}

{# ============================================
   EXAMPLE 6: Permission-Based Content
   ============================================ #}

<div class="card" style="margin-top: 1rem;">
  <div style="padding: 1rem;">
    <h3 style="margin: 0 0 1rem 0;">Customer Statistics</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
      {# Always visible #}
      <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 0.5rem;">
        <div style="font-size: 2rem; font-weight: 600;">{{ total_customers }}</div>
        <div style="color: var(--text-light);">Total Customers</div>
      </div>
      
      {# Only visible with order:read permission #}
      {% if can('order:read') %}
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 0.5rem;">
          <div style="font-size: 2rem; font-weight: 600;">{{ total_orders }}</div>
          <div style="color: var(--text-light);">Total Orders</div>
        </div>
      {% endif %}
      
      {# Only visible with quote:read permission #}
      {% if can('quote:read') %}
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 0.5rem;">
          <div style="font-size: 2rem; font-weight: 600;">${{ total_revenue }}</div>
          <div style="color: var(--text-light);">Total Revenue</div>
        </div>
      {% endif %}
      
      {# Only visible to SUPERADMIN #}
      {% if has.role('SUPERADMIN') %}
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 0.5rem;">
          <div style="font-size: 2rem; font-weight: 600;">{{ profit_margin }}%</div>
          <div style="color: var(--text-light);">Profit Margin</div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}

{# ============================================
   EXAMPLE 7: JavaScript Integration
   ============================================ #}

{% block scripts %}
<script>
  // Example: Confirm delete with modal
  function confirmDelete(id, name) {
    if (confirm(`Are you sure you want to delete customer "${name}"?`)) {
      // Perform delete action
      window.location.href = `/api/v1/admin/customers/${id}/delete`;
    }
  }
  
  // Example: Export selected customers
  function exportSelected() {
    const selected = document.querySelectorAll('input[name="customer_ids"]:checked');
    if (selected.length === 0) {
      alert('Please select at least one customer to export');
      return;
    }
    
    const ids = Array.from(selected).map(cb => cb.value);
    window.location.href = `/api/v1/admin/customers/export?ids=${ids.join(',')}`;
  }
  
  // Example: Send bulk email
  function sendBulkEmail() {
    const selected = document.querySelectorAll('input[name="customer_ids"]:checked');
    if (selected.length === 0) {
      alert('Please select at least one customer');
      return;
    }
    
    // Open email composer
    window.location.href = `/api/v1/admin/customers/bulk-email?count=${selected.length}`;
  }
  
  // Example: Delete bulk customers
  function deleteBulkCustomers() {
    const selected = document.querySelectorAll('input[name="customer_ids"]:checked');
    if (selected.length === 0) {
      alert('Please select at least one customer to delete');
      return;
    }
    
    if (confirm(`Are you sure you want to delete ${selected.length} customer(s)?`)) {
      const ids = Array.from(selected).map(cb => cb.value);
      // Perform bulk delete
      fetch('/api/v1/admin/customers/bulk-delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ids: ids})
      }).then(() => {
        window.location.reload();
      });
    }
  }
</script>
{% endblock %}
