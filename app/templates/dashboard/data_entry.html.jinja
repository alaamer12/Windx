{% extends "base.html.jinja" %}

{% block title %}Data Entry - Admin Dashboard{% endblock %}

{% block content %}
<div x-data="dataEntry()" x-init="init()">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Data Entry</h1>
        <p class="mt-2 text-gray-600">Add new data to the system with comprehensive form validation.</p>
    </div>
    
    <!-- Form Card -->
    <div class="card max-w-4xl mx-auto">
        <form @submit.prevent="submitForm" class="space-y-6">
            <!-- Basic Information Section -->
            <div>
                <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-user text-blue-600 mr-2"></i>
                    Basic Information
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Username -->
                    <div>
                        <label class="label" for="username">
                            Username <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="username" 
                            x-model="formData.username"
                            class="input-field"
                            placeholder="Enter username"
                            required
                            minlength="3"
                            maxlength="50"
                            pattern="[a-zA-Z0-9_]+"
                            @input="validateField('username')"
                        >
                        <p x-show="errors.username" x-text="errors.username" class="mt-1 text-sm text-red-600"></p>
                    </div>
                    
                    <!-- Email -->
                    <div>
                        <label class="label" for="email">
                            Email Address <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="email" 
                            id="email" 
                            x-model="formData.email"
                            class="input-field"
                            placeholder="user@example.com"
                            required
                            @input="validateField('email')"
                        >
                        <p x-show="errors.email" x-text="errors.email" class="mt-1 text-sm text-red-600"></p>
                    </div>
                    
                    <!-- Full Name -->
                    <div>
                        <label class="label" for="full_name">
                            Full Name
                        </label>
                        <input 
                            type="text" 
                            id="full_name" 
                            x-model="formData.full_name"
                            class="input-field"
                            placeholder="John Doe"
                            maxlength="100"
                        >
                    </div>
                    
                    <!-- Password -->
                    <div>
                        <label class="label" for="password">
                            Password <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input 
                                :type="showPassword ? 'text' : 'password'" 
                                id="password" 
                                x-model="formData.password"
                                class="input-field pr-10"
                                placeholder="••••••••"
                                required
                                minlength="8"
                                @input="validateField('password')"
                            >
                            <button 
                                type="button"
                                @click="showPassword = !showPassword"
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                            >
                                <i :class="showPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                            </button>
                        </div>
                        <p x-show="errors.password" x-text="errors.password" class="mt-1 text-sm text-red-600"></p>
                        <p class="mt-1 text-xs text-gray-500">Minimum 8 characters</p>
                    </div>
                </div>
            </div>
            
            <!-- Status Section -->
            <div>
                <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-toggle-on text-blue-600 mr-2"></i>
                    Status & Permissions
                </h2>
                
                <div class="space-y-4">
                    <!-- Active Status -->
                    <div class="flex items-center">
                        <input 
                            type="checkbox" 
                            id="is_active" 
                            x-model="formData.is_active"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                        >
                        <label for="is_active" class="ml-2 block text-sm text-gray-900">
                            <span class="font-medium">Active Account</span>
                            <span class="text-gray-500 ml-2">User can login and access the system</span>
                        </label>
                    </div>
                    
                    <!-- Superuser Status -->
                    <div class="flex items-center">
                        <input 
                            type="checkbox" 
                            id="is_superuser" 
                            x-model="formData.is_superuser"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                        >
                        <label for="is_superuser" class="ml-2 block text-sm text-gray-900">
                            <span class="font-medium">Superuser</span>
                            <span class="text-gray-500 ml-2">Grant admin privileges</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Image Upload Section -->
            <div>
                <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-image text-blue-600 mr-2"></i>
                    Profile Image (Optional)
                </h2>
                
                <div class="space-y-4">
                    <!-- Image Upload -->
                    <div>
                        <label class="label">
                            Upload Image
                        </label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-blue-500 transition-colors">
                            <div class="space-y-1 text-center">
                                <div x-show="!imagePreview">
                                    <i class="fas fa-cloud-upload-alt text-gray-400 text-5xl mb-3"></i>
                                    <div class="flex text-sm text-gray-600">
                                        <label for="image-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                            <span>Upload a file</span>
                                            <input 
                                                id="image-upload" 
                                                type="file" 
                                                class="sr-only"
                                                accept="image/*"
                                                @change="handleImageUpload"
                                            >
                                        </label>
                                        <p class="pl-1">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                                </div>
                                
                                <!-- Image Preview -->
                                <div x-show="imagePreview" class="relative">
                                    <img :src="imagePreview" class="mx-auto h-48 w-48 object-cover rounded-lg">
                                    <button 
                                        type="button"
                                        @click="removeImage"
                                        class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-2 hover:bg-red-600 transition-colors"
                                    >
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Additional Fields Section -->
            <div>
                <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-list text-blue-600 mr-2"></i>
                    Additional Information
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Date Field -->
                    <div>
                        <label class="label" for="join_date">
                            Join Date
                        </label>
                        <input 
                            type="date" 
                            id="join_date" 
                            x-model="formData.join_date"
                            class="input-field"
                        >
                    </div>
                    
                    <!-- Select Field -->
                    <div>
                        <label class="label" for="role">
                            Role
                        </label>
                        <select 
                            id="role" 
                            x-model="formData.role"
                            class="input-field"
                        >
                            <option value="">Select a role</option>
                            <option value="user">User</option>
                            <option value="moderator">Moderator</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    
                    <!-- Number Field -->
                    <div>
                        <label class="label" for="age">
                            Age
                        </label>
                        <input 
                            type="number" 
                            id="age" 
                            x-model="formData.age"
                            class="input-field"
                            min="18"
                            max="120"
                            placeholder="18"
                        >
                    </div>
                    
                    <!-- URL Field -->
                    <div>
                        <label class="label" for="website">
                            Website
                        </label>
                        <input 
                            type="url" 
                            id="website" 
                            x-model="formData.website"
                            class="input-field"
                            placeholder="https://example.com"
                        >
                    </div>
                </div>
            </div>
            
            <!-- Textarea Section -->
            <div>
                <label class="label" for="bio">
                    Biography
                </label>
                <textarea 
                    id="bio" 
                    x-model="formData.bio"
                    rows="4"
                    class="input-field"
                    placeholder="Tell us about yourself..."
                    maxlength="500"
                ></textarea>
                <p class="mt-1 text-sm text-gray-500">
                    <span x-text="formData.bio ? formData.bio.length : 0"></span>/500 characters
                </p>
            </div>
            
            <!-- Form Actions -->
            <div class="flex items-center justify-between pt-6 border-t border-gray-200">
                <button 
                    type="button"
                    @click="resetForm"
                    class="btn-secondary"
                >
                    <i class="fas fa-redo mr-2"></i>
                    Reset Form
                </button>
                
                <div class="flex space-x-3">
                    <button 
                        type="button"
                        @click="saveAsDraft"
                        class="btn-secondary"
                    >
                        <i class="fas fa-save mr-2"></i>
                        Save Draft
                    </button>
                    
                    <button 
                        type="submit"
                        class="btn-primary"
                        :disabled="isSubmitting"
                    >
                        <i class="fas fa-check mr-2"></i>
                        <span x-text="isSubmitting ? 'Submitting...' : 'Submit'"></span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function dataEntry() {
        return {
            formData: {
                username: '',
                email: '',
                full_name: '',
                password: '',
                is_active: true,
                is_superuser: false,
                join_date: new Date().toISOString().split('T')[0],
                role: '',
                age: '',
                website: '',
                bio: ''
            },
            errors: {},
            showPassword: false,
            imagePreview: null,
            imageFile: null,
            isSubmitting: false,
            
            init() {
                // Load draft if exists
                const draft = localStorage.getItem('formDraft');
                if (draft) {
                    this.formData = JSON.parse(draft);
                    showToast('Draft loaded', 'info');
                }
            },
            
            validateField(field) {
                this.errors[field] = '';
                
                if (field === 'username') {
                    if (this.formData.username.length < 3) {
                        this.errors.username = 'Username must be at least 3 characters';
                    } else if (!/^[a-zA-Z0-9_]+$/.test(this.formData.username)) {
                        this.errors.username = 'Username can only contain letters, numbers, and underscores';
                    }
                }
                
                if (field === 'email') {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(this.formData.email)) {
                        this.errors.email = 'Please enter a valid email address';
                    }
                }
                
                if (field === 'password') {
                    if (this.formData.password.length < 8) {
                        this.errors.password = 'Password must be at least 8 characters';
                    }
                }
            },
            
            handleImageUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 10 * 1024 * 1024) {
                        showToast('Image size must be less than 10MB', 'error');
                        return;
                    }
                    
                    this.imageFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.imagePreview = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    showToast('Image uploaded successfully', 'success');
                }
            },
            
            removeImage() {
                this.imagePreview = null;
                this.imageFile = null;
                document.getElementById('image-upload').value = '';
                showToast('Image removed', 'info');
            },
            
            async submitForm() {
                // Validate all fields
                this.validateField('username');
                this.validateField('email');
                this.validateField('password');
                
                if (Object.values(this.errors).some(error => error !== '')) {
                    showToast('Please fix validation errors', 'error');
                    return;
                }
                
                this.isSubmitting = true;
                
                try {
                    const response = await fetch('/api/v1/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            username: this.formData.username,
                            email: this.formData.email,
                            password: this.formData.password,
                            full_name: this.formData.full_name || null
                        })
                    });
                    
                    if (response.ok) {
                        showToast('User created successfully!', 'success');
                        this.resetForm();
                        localStorage.removeItem('formDraft');
                        
                        // Redirect to dashboard after 2 seconds
                        setTimeout(() => {
                            window.location.href = '/api/v1/dashboard/';
                        }, 2000);
                    } else {
                        const error = await response.json();
                        showToast(error.message || 'Failed to create user', 'error');
                    }
                } catch (error) {
                    console.error('Submit error:', error);
                    showToast('An error occurred. Please try again.', 'error');
                } finally {
                    this.isSubmitting = false;
                }
            },
            
            saveAsDraft() {
                localStorage.setItem('formDraft', JSON.stringify(this.formData));
                showToast('Draft saved successfully', 'success');
            },
            
            resetForm() {
                if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
                    this.formData = {
                        username: '',
                        email: '',
                        full_name: '',
                        password: '',
                        is_active: true,
                        is_superuser: false,
                        join_date: new Date().toISOString().split('T')[0],
                        role: '',
                        age: '',
                        website: '',
                        bio: ''
                    };
                    this.errors = {};
                    this.removeImage();
                    localStorage.removeItem('formDraft');
                    showToast('Form reset', 'info');
                }
            }
        }
    }
</script>
{% endblock %}
