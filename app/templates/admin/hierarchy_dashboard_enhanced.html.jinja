{% extends "admin/base.html.jinja" %}

{% block title %}Hierarchy Editor - WindX Admin{% endblock %}

{% set active_page = "hierarchy" %}

{% block extra_css %}
<style>
    /* Tooltip Styles */
    .tooltip-trigger {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        font-size: 0.75rem;
        font-weight: 700;
        cursor: help;
        margin-left: 0.5rem;
        position: relative;
    }
    
    .tooltip-trigger:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        background: #1e293b;
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 400;
        white-space: nowrap;
        max-width: 300px;
        white-space: normal;
        width: max-content;
        z-index: 1000;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    }
    
    .tooltip-trigger:hover::before {
        content: '';
        position: absolute;
        bottom: calc(100% + 2px);
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: #1e293b;
        z-index: 1000;
    }
    
    /* Enhanced Form Styling */
    .enhanced-selector {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 1rem;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
    }
    
    .enhanced-selector label {
        color: white;
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
    }
    
    .enhanced-selector select {
        background: white;
        border: none;
        padding: 1rem;
        border-radius: 0.75rem;
        font-size: 1rem;
        width: 100%;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .enhanced-selector .btn {
        background: white;
        color: #667eea;
        font-weight: 600;
        padding: 1rem 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .enhanced-selector .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
    }
    
    /* Info Bar Enhancement */
    .info-bar-enhanced {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border: none;
        color: white;
        padding: 1.5rem;
        border-radius: 1rem;
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .info-bar-enhanced strong {
        font-size: 1.25rem;
    }
    
    .info-bar-enhanced .btn {
        background: white;
        color: #f5576c;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        height: calc(100vh - 350px);
    }
    
    .scrollable-column {
        height: 100%;
        overflow-y: auto;
        background-color: white;
        border: 2px solid var(--border);
        border-radius: 1rem;
        padding: 0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    
    .column-header {
        padding: 1.5rem;
        border-bottom: 2px solid var(--border);
        background: #f8fafc;
        font-weight: 700;
        font-size: 1.125rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: 1rem 1rem 0 0;
    }
    
    .column-content {
        padding: 1.5rem;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-light);
    }
    
    .empty-state-icon {
        font-size: 4rem;
        opacity: 0.3;
        margin-bottom: 1rem;
    }
    
    /* Tab Navigation */
    .tab-nav {
        display: flex;
        border-bottom: 2px solid var(--border);
        margin-bottom: 0;
        background: #f1f5f9;
        border-radius: 1rem 1rem 0 0;
        padding: 0.75rem 0.75rem 0;
    }
    
    .tab-btn {
        padding: 0.875rem 1.75rem;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 600;
        color: var(--text-light);
        border-radius: 0.75rem 0.75rem 0 0;
        transition: all 0.2s;
    }
    
    .tab-btn:hover {
        background: rgba(255, 255, 255, 0.5);
    }
    
    .tab-btn.active {
        background: white;
        color: var(--primary);
        border: 2px solid var(--border);
        border-bottom: 2px solid white;
        margin-bottom: -2px;
    }
    
    .tab-content {
        background: white;
        border: 2px solid var(--border);
        border-top: none;
        border-radius: 0 0 1rem 1rem;
        height: calc(100% - 55px);
        overflow: hidden;
    }
    
    .tab-pane {
        display: none;
        height: 100%;
        overflow-y: auto;
        padding: 1.5rem;
    }
    
    .tab-pane.active {
        display: block;
    }
    
    /* Help Section */
    .help-box {
        background: #eff6ff;
        border-left: 4px solid var(--primary);
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        line-height: 1.6;
    }
    
    .help-box strong {
        color: var(--primary);
    }
</style>
{% endblock %}

{% block content %}
<!-- Flash Messages -->
{% include "admin/components/alerts.html.jinja" %}

<div class="page-header">
    <div>
        <h1 class="page-title" style="display: flex; align-items: center;">
            üå≥ Hierarchy Editor
            <span class="tooltip-trigger" data-tooltip="Build your product's attribute tree here. Start by selecting a manufacturing type, then create categories, attributes, and options.">!</span>
        </h1>
        <p style="color: var(--text-light); margin-top: 0.5rem;">Build dynamic attribute hierarchies for your products</p>
    </div>
    <a href="/api/v1/admin/documentation#hierarchy" class="btn btn-outline">
        üìö View Guide
    </a>
</div>

<!-- Manufacturing Type Selector -->
<div class="enhanced-selector">
    <form method="GET" action="/api/v1/admin/hierarchy" style="display: grid; grid-template-columns: 1fr auto; gap: 1.5rem; align-items: end;">
        <div>
            <label for="manufacturing_type_id">
                Select Manufacturing Type
                <span class="tooltip-trigger" data-tooltip="Choose the product type you want to configure. Each type has its own independent attribute hierarchy.">!</span>
            </label>
            <select name="manufacturing_type_id" id="manufacturing_type_id" class="form-control" onchange="this.form.submit()">
                <option value="">-- Select a Type --</option>
                {% for mfg_type in manufacturing_types %}
                <option value="{{ mfg_type.id }}" {% if mfg_type.id == selected_type_id %}selected{% endif %}>
                    {{ mfg_type.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn">Load Hierarchy</button>
    </form>
</div>

{% if selected_manufacturing_type %}
<!-- Selected Type Info -->
<div class="info-bar-enhanced">
    <div>
        <strong>{{ selected_manufacturing_type.name }}</strong>
        <div style="opacity: 0.9; margin-top: 0.25rem;">
            Base Price: ${{ "%.2f"|format(selected_manufacturing_type.base_price) }} | 
            Base Weight: {{ "%.2f"|format(selected_manufacturing_type.base_weight) }} kg
        </div>
    </div>
    <a href="/api/v1/admin/hierarchy/node/create?manufacturing_type_id={{ selected_type_id }}" class="btn">
        + Create Root Node
        <span class="tooltip-trigger" data-tooltip="Create the first node in your hierarchy. This is the top-level category that will contain all other attributes.">!</span>
    </a>
</div>

<!-- Help Box -->
<div class="help-box">
    <strong>üí° Quick Start:</strong> 
    {% if not attribute_nodes %}
    Click "Create Root Node" to start building your hierarchy. A root node is the top-level category (e.g., "Frame Material", "Glass Type").
    {% else %}
    Click on any node in the tree to view its details. Use "Add Child" to create sub-attributes. Hover over the (!) icons for help.
    {% endif %}
</div>

<div class="dashboard-grid">
    <!-- Left Column: Tree View -->
    <div class="scrollable-column">
        <div class="column-header">
            Attribute Tree
            <span class="tooltip-trigger" data-tooltip="Visual representation of your product's attribute hierarchy. Click nodes to view/edit details.">!</span>
        </div>
        
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab(event, 'tree-tab')">
                üå≤ Tree View
            </button>
            <button class="tab-btn" onclick="switchTab(event, 'diagram-tab')">
                üìä Diagram
            </button>
        </div>
        
        <div class="tab-content">
            <div id="tree-tab" class="tab-pane active">
                {% if attribute_nodes %}
                    <div style="font-family: monospace; font-size: 0.875rem; line-height: 1.8;">
                        {% for node in attribute_nodes %}
                        <div style="padding: 0.5rem; margin: 0.25rem 0; background: #f8fafc; border-radius: 0.375rem; cursor: pointer; transition: all 0.2s;" 
                             onclick="selectNode({{ node.id }})"
                             onmouseover="this.style.background='#eff6ff'"
                             onmouseout="this.style.background='#f8fafc'">
                            <span style="color: #94a3b8;">{{ node.ltree_path }}</span>
                            <strong style="margin-left: 0.5rem;">{{ node.name }}</strong>
                            <span style="margin-left: 0.5rem; padding: 0.125rem 0.5rem; background: #dbeafe; color: #1e40af; border-radius: 0.25rem; font-size: 0.75rem;">
                                {{ node.node_type }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">üå±</div>
                        <h3>No Attribute Nodes</h3>
                        <p>Create your first node to start building the hierarchy.</p>
                        <a href="/api/v1/admin/hierarchy/node/create?manufacturing_type_id={{ selected_type_id }}" class="btn btn-primary" style="margin-top: 1rem;">
                            Create First Node
                        </a>
                    </div>
                {% endif %}
            </div>
            
            <div id="diagram-tab" class="tab-pane">
                {% if ascii_tree %}
                    <pre style="font-family: monospace; font-size: 0.875rem; line-height: 1.6; color: #475569;">{{ ascii_tree }}</pre>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>(Empty tree)</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Right Column: Node Details/Form -->
    <div class="scrollable-column">
        <div class="column-header">
            Node Details
            <span class="tooltip-trigger" data-tooltip="View and edit the selected node's properties. Each field affects how the attribute behaves in customer configurations.">!</span>
        </div>
        
        <div class="column-content">
            <div class="empty-state">
                <div class="empty-state-icon">üëà</div>
                <h3>Select a Node</h3>
                <p>Click on a node in the tree to view and edit its details.</p>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="card" style="text-align: center; padding: 4rem 2rem;">
    <div style="font-size: 4rem; opacity: 0.3; margin-bottom: 1rem;">üè≠</div>
    <h2 style="margin-bottom: 1rem;">No Manufacturing Type Selected</h2>
    <p style="color: var(--text-light); margin-bottom: 2rem;">
        Select a manufacturing type above to start building its attribute hierarchy.
    </p>
    {% if not manufacturing_types %}
    <a href="/api/v1/admin/manufacturing-types/create" class="btn btn-primary">
        Create Your First Manufacturing Type
    </a>
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    function switchTab(event, tabId) {
        // Remove active class from all tabs and panes
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding pane
        event.target.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }
    
    function selectNode(nodeId) {
        // Navigate to node edit page
        window.location.href = `/api/v1/admin/hierarchy/node/${nodeId}/edit?manufacturing_type_id={{ selected_type_id }}`;
    }
</script>
{% endblock %}
