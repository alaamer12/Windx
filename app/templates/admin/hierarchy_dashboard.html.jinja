{% extends "admin/base.html.jinja" %}
{% from "components/buttons.html.jinja" import button with context %}

{% block title %}Hierarchy Dashboard - WindX Admin{% endblock %}

{% set active_page = "hierarchy" %}

{% block extra_css %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        height: calc(100vh - 200px);
    }

    .scrollable-column {
        height: 100%;
        overflow-y: auto;
        background-color: #f8fafc;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-light);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    .empty-state-icon {
        font-size: 3rem;
        opacity: 0.5;
    }

    .selector-form {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
    }

    .selector-group {
        flex: 1;
    }

    .info-bar {
        background-color: #eff6ff;
        border: 1px solid #dbeafe;
        color: #1e40af;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .tab-nav {
        display: flex;
        border-bottom: 1px solid var(--border);
        margin-bottom: 0;
        background: #f1f5f9;
        border-radius: 0.5rem 0.5rem 0 0;
        padding: 0.5rem 0.5rem 0;
    }

    .tab-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 500;
        color: var(--text-light);
        border-radius: 0.5rem 0.5rem 0 0;
    }

    .tab-btn.active {
        background: white;
        color: var(--primary);
        border: 1px solid var(--border);
        border-bottom: 1px solid white;
        margin-bottom: -1px;
    }

    .tab-content {
        background: white;
        border: 1px solid var(--border);
        border-top: none;
        border-radius: 0 0 0.5rem 0.5rem;
        height: calc(100% - 45px);
        overflow: hidden;
    }
    
    .tab-pane {
        display: none;
        height: 100%;
        overflow-y: auto;
        padding: 1rem;
    }
    
    .tab-pane.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Hierarchy Editor</h1>
</div>

<!-- Manufacturing Type Selector -->
<div class="card">
    <form method="GET" action="/api/v1/admin/hierarchy" class="selector-form">
        <div class="selector-group">
            <label for="manufacturing_type_id" class="form-label">Select Manufacturing Type</label>
            <select name="manufacturing_type_id" id="manufacturing_type_id" class="form-control" onchange="this.form.submit()">
                <option value="">-- Select a Type --</option>
                {% for mfg_type in manufacturing_types %}
                <option value="{{ mfg_type.id }}" {% if mfg_type.id == selected_type_id %}selected{% endif %}>
                    {{ mfg_type.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        {{ button(
            text="Load",
            type="submit",
            variant="primary"
        ) }}
    </form>
</div>

{% if selected_manufacturing_type %}
<!-- Selected Type Info -->
<div class="info-bar">
    <div>
        <strong>{{ selected_manufacturing_type.name }}</strong>
        <span style="margin: 0 0.5rem; opacity: 0.5;">|</span>
        Base Price: ${{ "%.2f"|format(selected_manufacturing_type.base_price) }}
    </div>
    {{ button(
        text="‚ûï Create Root Node",
        href="/api/v1/admin/hierarchy/node/create?manufacturing_type_id=" + selected_type_id|string,
        variant="primary",
        size="sm"
    ) }}
</div>

<div class="dashboard-grid">
    <!-- Left Column: Tree View -->
    <div class="card" style="margin: 0; padding: 0; overflow: hidden; display: flex; flex-direction: column;">
        <div style="padding: 1rem; border-bottom: 1px solid var(--border); background: #f8fafc; font-weight: 600;">
            Attribute Tree
        </div>
        <div style="flex: 1; overflow-y: auto; padding: 1rem;">
            {% if tree_nodes %}
                {% include "admin/components/tree_view.html.jinja" %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üå≥</div>
                    <p>No attribute nodes found.</p>
                    {{ button(
                        text="Create First Node",
                        href="/api/v1/admin/hierarchy/node/create?manufacturing_type_id=" + selected_type_id|string,
                        variant="primary"
                    ) }}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Right Column: Visualizations -->
    <div style="display: flex; flex-direction: column;">
        <div class="tab-nav">
            {{ button("üå≥ ASCII Tree", onclick="openTab(event, 'ascii-pane')", variant="tab", class="tab-btn active", type="button") }}
            {{ button("üìä Diagram", onclick="openTab(event, 'diagram-pane')", variant="tab", class="tab-btn", type="button") }}
        </div>
        <div class="tab-content">
            <div id="ascii-pane" class="tab-pane active">
                {% if ascii_tree %}
                    <pre style="font-family: monospace; font-size: 0.9rem;">{{ ascii_tree }}</pre>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No tree visualization available.</p>
                    </div>
                {% endif %}
            </div>
            <div id="diagram-pane" class="tab-pane">
                {% if diagram_tree %}
                    <img src="data:image/png;base64,{{ diagram_tree }}" alt="Tree Diagram" style="max-width: 100%;">
                {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>No diagram visualization available.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- No Selection State -->
<div class="empty-state" style="background: white; border-radius: 1rem; border: 1px solid var(--border);">
    <div class="empty-state-icon">üëà</div>
    <h3>Select a Manufacturing Type</h3>
    <p>Choose a product type from the dropdown above to start editing.</p>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    function openTab(evt, tabName) {
        var i, tabContent, tabLinks;
        tabContent = document.getElementsByClassName("tab-pane");
        for (i = 0; i < tabContent.length; i++) {
            tabContent[i].style.display = "none";
            tabContent[i].classList.remove("active");
        }
        tabLinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tabLinks.length; i++) {
            tabLinks[i].className = tabLinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.className += " active";
    }
</script>
{% endblock %}
