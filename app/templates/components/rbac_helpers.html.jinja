{# RBAC Helper Macros - Core RBAC-aware UI components #}

{# 
  RBAC Button Macro
  Renders a button/link only if user has required permissions or role
  
  Parameters:
    - text: Button text to display
    - href: URL to link to
    - permission: Optional permission string (e.g., "customer:read")
    - role: Optional role requirement (e.g., "SUPERADMIN")
    - class: CSS classes for the button (default: "btn btn-primary")
    - icon: Optional icon to display before text
    - onclick: Optional onclick handler
  
  Usage:
    {{ rbac_button("New Customer", "/customers/new", permission="customer:create", icon="âž•") }}
    {{ rbac_button("Settings", "/settings", role="SUPERADMIN", class="btn btn-outline") }}
#}
{% macro rbac_button(text, href, permission=None, role=None, class="btn btn-primary", icon=None, onclick=None) %}
  {% if not permission or can(permission) %}
    {% if not role or has.role(role) %}
      <a href="{{ href }}" class="{{ class }}" {% if onclick %}onclick="{{ onclick }}"{% endif %}>
        {% if icon %}<span class="btn-icon">{{ icon }}</span> {% endif %}{{ text }}
      </a>
    {% endif %}
  {% endif %}
{% endmacro %}

{# 
  RBAC Navigation Item Macro
  Renders a navigation link only if user has required permissions or role
  
  Parameters:
    - text: Navigation item text
    - href: URL to link to
    - permission: Optional permission string
    - role: Optional role requirement
    - active: Boolean indicating if this is the active page
    - icon: Optional icon to display
    - badge: Optional badge text (e.g., "Beta", "Soon")
    - disabled: Boolean to render as disabled item
  
  Usage:
    {{ rbac_nav_item("Dashboard", "/dashboard", active=True, icon="ðŸ“Š") }}
    {{ rbac_nav_item("Customers", "/customers", permission="customer:read", icon="ðŸ‘¥", badge="Beta") }}
#}
{% macro rbac_nav_item(text, href, permission=None, role=None, active=False, icon=None, badge=None, disabled=False) %}
  {% if not permission or can(permission) %}
    {% if not role or has.role(role) %}
      {% if disabled %}
        <div class="nav-link disabled" title="Coming Soon">
          {% if icon %}<span class="nav-icon">{{ icon }}</span>{% endif %}
          <span class="nav-text">{{ text }}</span>
          {% if badge %}<span class="badge-soon">{{ badge }}</span>{% endif %}
        </div>
      {% else %}
        <a href="{{ href }}" class="nav-link {% if active %}active{% endif %}">
          {% if icon %}<span class="nav-icon">{{ icon }}</span>{% endif %}
          <span class="nav-text">{{ text }}</span>
          {% if badge %}<span class="badge-beta">{{ badge }}</span>{% endif %}
        </a>
      {% endif %}
    {% endif %}
  {% endif %}
{% endmacro %}

{# 
  Protected Content Macro
  Wraps content that should only be visible with required permissions or role
  
  Parameters:
    - permission: Optional permission string
    - role: Optional role requirement
    - fallback_message: Optional message to show when access is denied
  
  Usage:
    {% call protected_content(permission="customer:delete", fallback_message="Insufficient permissions") %}
      <button class="btn-danger">Delete Customer</button>
    {% endcall %}
#}
{% macro protected_content(permission=None, role=None, fallback_message=None) %}
  {% if not permission or can(permission) %}
    {% if not role or has.role(role) %}
      {{ caller() }}
    {% elif fallback_message %}
      <div class="text-gray-500 italic">{{ fallback_message }}</div>
    {% endif %}
  {% elif fallback_message %}
    <div class="text-gray-500 italic">{{ fallback_message }}</div>
  {% endif %}
{% endmacro %}

{# 
  RBAC Page Header Macro
  Renders a page header with title, subtitle, and conditional action buttons
  
  Parameters:
    - title: Page title
    - subtitle: Optional subtitle text
    - actions: List of action configurations (each with text, href, permission, role, class, icon)
  
  Usage:
    {{ rbac_page_header(
      "Manufacturing Types",
      subtitle="Manage product categories",
      actions=[
        {"text": "New Type", "href": "/types/new", "permission": "manufacturing_type:create", "icon": "âž•"}
      ]
    ) }}
#}
{% macro rbac_page_header(title, subtitle=None, actions=[]) %}
  <div class="page-header">
    <div>
      <h1 class="page-title">{{ title }}</h1>
      {% if subtitle %}
        <p class="text-gray-500 mt-1">{{ subtitle }}</p>
      {% endif %}
    </div>
    {% if actions %}
      <div class="flex gap-2">
        {% for action in actions %}
          {{ rbac_button(
            action.text,
            action.href,
            permission=action.get('permission'),
            role=action.get('role'),
            class=action.get('class', 'btn btn-primary'),
            icon=action.get('icon'),
            onclick=action.get('onclick')
          ) }}
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% endmacro %}
