{% extends "admin/base.html.jinja" %}

{% block title %}Order {{ order.order_number }} - WindX Admin{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <div class="flex items-center gap-3">
            <h1 class="page-title">Order {{ order.order_number }}</h1>
            <span class="px-3 py-1 rounded-full text-sm font-medium
                {% if order.status == 'confirmed' %}bg-blue-100 text-blue-800
                {% elif order.status == 'production' %}bg-purple-100 text-purple-800
                {% elif order.status == 'shipped' %}bg-indigo-100 text-indigo-800
                {% elif order.status == 'delivered' %}bg-green-100 text-green-800
                {% elif order.status == 'cancelled' %}bg-red-100 text-red-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {{ order.status|upper }}
            </span>
        </div>
        <p class="text-gray-500 mt-1">Placed on {{ order.order_date.strftime('%B %d, %Y at %I:%M %p') }}</p>
    </div>
    <a href="/api/v1/admin/orders" class="btn btn-outline">
        <span>‚Üê</span> Back to Orders
    </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column: Order Info & Actions -->
    <div class="lg:col-span-1 space-y-6">
        <!-- Status Update -->
        <div class="card">
            <h3 class="text-lg font-semibold mb-4 border-b pb-2">Update Status</h3>
            <form action="/api/v1/admin/orders/{{ order.id }}/status" method="post" class="space-y-4">
                <div class="form-group">
                    <label class="form-label" for="status">New Status</label>
                    <select id="status" name="status" class="form-control">
                        <option value="confirmed" {% if order.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                        <option value="production" {% if order.status == 'production' %}selected{% endif %}>Production</option>
                        <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>Shipped</option>
                        <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>Delivered</option>
                        <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-full">Update Status</button>
            </form>
        </div>

        <!-- Customer Info -->
        <div class="card">
            <h3 class="text-lg font-semibold mb-4 border-b pb-2">Customer</h3>
            {% if order.quote and order.quote.customer %}
            <div class="space-y-3">
                <div>
                    <p class="font-medium text-lg">
                        <a href="/api/v1/admin/customers/{{ order.quote.customer.id }}" class="text-blue-600 hover:underline">
                            {{ order.quote.customer.company_name or order.quote.customer.contact_person }}
                        </a>
                    </p>
                    <p class="text-gray-500">{{ order.quote.customer.contact_person }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Email</p>
                    <p>{{ order.quote.customer.email }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Phone</p>
                    <p>{{ order.quote.customer.phone or 'N/A' }}</p>
                </div>
            </div>
            {% else %}
            <p class="text-gray-500">Unknown Customer</p>
            {% endif %}
        </div>

        <!-- Shipping Address -->
        <div class="card">
            <h3 class="text-lg font-semibold mb-4 border-b pb-2">Installation/Shipping Address</h3>
            {% if order.installation_address %}
            <address class="not-italic text-gray-600">
                {{ order.installation_address.street }}<br>
                {{ order.installation_address.city }}, {{ order.installation_address.state }} {{ order.installation_address.zip }}<br>
                {{ order.installation_address.country }}
            </address>
            {% else %}
            <p class="text-gray-400">No address provided</p>
            {% endif %}
        </div>
    </div>

    <!-- Right Column: Order Items -->
    <div class="lg:col-span-2 space-y-6">
        <div class="card">
            <h3 class="text-lg font-semibold mb-4 border-b pb-2">Order Items</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-4 py-2">Item</th>
                            <th class="px-4 py-2 text-center">Qty</th>
                            <th class="px-4 py-2 text-right">Unit Price</th>
                            <th class="px-4 py-2 text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.items %}
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-3">
                                <div class="font-medium">{{ item.configuration_snapshot.name }}</div>
                                <div class="text-xs text-gray-500 mt-1">
                                    {{ item.configuration_snapshot.manufacturing_type.name }}
                                    {% if item.configuration_snapshot.selections %}
                                    <ul class="list-disc list-inside mt-1">
                                        {% for sel in item.configuration_snapshot.selections %}
                                        <li>{{ sel.attribute_node.name }}: {{ sel.value }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-4 py-3 text-center">{{ item.quantity }}</td>
                            <td class="px-4 py-3 text-right">${{ "%.2f"|format(item.unit_price) }}</td>
                            <td class="px-4 py-3 text-right font-medium">${{ "%.2f"|format(item.total_price) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="bg-gray-50 font-semibold text-gray-900">
                        <tr>
                            <td colspan="3" class="px-4 py-3 text-right">Subtotal</td>
                            <td class="px-4 py-3 text-right">${{ "%.2f"|format(order.quote.total_amount) }}</td>
                        </tr>
                        <!-- Add tax/shipping rows if available in model -->
                        <tr>
                            <td colspan="3" class="px-4 py-3 text-right text-lg">Total</td>
                            <td class="px-4 py-3 text-right text-lg">${{ "%.2f"|format(order.quote.total_amount) }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- Timeline/History (Placeholder) -->
        <div class="card">
            <h3 class="text-lg font-semibold mb-4 border-b pb-2">Order Timeline</h3>
            <div class="relative border-l border-gray-200 ml-3 space-y-6">
                <div class="mb-4 ml-6">
                    <span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white">
                        üìù
                    </span>
                    <h4 class="flex items-center mb-1 text-sm font-semibold text-gray-900">Order Placed</h4>
                    <time class="block mb-2 text-xs font-normal leading-none text-gray-400">{{ order.order_date.strftime('%B %d, %Y') }}</time>
                    <p class="text-sm font-normal text-gray-500">Order #{{ order.order_number }} created from Quote #{{ order.quote.quote_number if order.quote else 'N/A' }}</p>
                </div>
                <!-- More timeline events could be added here based on audit logs -->
            </div>
        </div>
    </div>
</div>
{% endblock %}
