"""Admin Entry Page management endpoints.

This module provides admin-only endpoints for the Entry Page system including
profile data entry, schema generation, and preview functionality within the admin interface.

Public Variables:
    router: FastAPI router for admin entry page endpoints

Features:
    - Profile form schema generation (admin interface)
    - Profile data saving and loading (admin interface)
    - Real-time preview generation (admin interface)
    - Conditional field visibility evaluation (admin interface)
    - HTML page rendering for admin entry pages
    - Superuser authentication and authorization
    - Comprehensive error handling
"""

from __future__ import annotations

from typing import Annotated, Any

from fastapi import APIRouter, HTTPException, Query, Request, status
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates
from pydantic import PositiveInt

from app.api.deps import get_admin_context
from app.api.types import CurrentSuperuser, DBSession
from app.core.exceptions import ValidationException
from app.schemas.configuration import Configuration
from app.schemas.entry import (
    InlineEditRequest,
    PreviewTable,
    ProfileEntryData,
    ProfilePreviewData,
    ProfileSchema,
)

from app.schemas.responses import get_common_responses

__all__ = ["router"]

router = APIRouter(
    tags=["Admin Entry"],
    responses=get_common_responses(401, 403, 500),
)

templates = Jinja2Templates(directory="app/templates")


@router.get(
    "/profile/schema/{manufacturing_type_id}",
    response_model=ProfileSchema,
    summary="Get Profile Form Schema (Admin)",
    description="Get dynamic form schema for profile data entry based on manufacturing type (admin interface)",
    response_description="Profile form schema with sections and fields",
    operation_id="getAdminProfileSchema",
    responses={
        200: {
            "description": "Successfully retrieved profile schema",
        },
        404: {
            "description": "Manufacturing type not found",
        },
        **get_common_responses(401, 403, 500),
    },
)
async def get_profile_schema(
    manufacturing_type_id: PositiveInt,
    current_superuser: CurrentSuperuser,
    db: DBSession,
) -> ProfileSchema:
    """Get profile form schema for a manufacturing type (admin interface).

    Generates dynamic form schema based on the attribute hierarchy
    defined for the specified manufacturing type.

    Args:
        manufacturing_type_id (PositiveInt): Manufacturing type ID
        current_superuser (User): Current authenticated superuser
        db (AsyncSession): Database session

    Returns:
        ProfileSchema: Generated form schema with sections and conditional logic

    Raises:
        NotFoundException: If manufacturing type not found

    Example:
        GET /api/v1/admin/entry/profile/schema/1
    """
    from app.services.entry import EntryService

    entry_service = EntryService(db)
    return await entry_service.get_profile_schema(manufacturing_type_id)


@router.get(
    "/profile/headers/{manufacturing_type_id}",
    response_model=list[str],
    summary="Get Dynamic Preview Headers (Admin)",
    description="Get dynamic preview headers for a manufacturing type based on attribute nodes",
    response_description="List of preview headers in correct order",
    operation_id="getAdminPreviewHeaders",
    responses={
        200: {
            "description": "Successfully retrieved preview headers",
        },
        404: {
            "description": "Manufacturing type not found",
        },
        **get_common_responses(401, 403, 500),
    },
)
async def get_preview_headers(
    manufacturing_type_id: PositiveInt,
    current_superuser: CurrentSuperuser,
    db: DBSession,
) -> list[str]:
    """Get dynamic preview headers for a manufacturing type (admin interface).

    Generates dynamic preview headers based on the attribute hierarchy
    defined for the specified manufacturing type, respecting sort_order.

    Args:
        manufacturing_type_id (PositiveInt): Manufacturing type ID
        current_superuser (User): Current authenticated superuser
        db (AsyncSession): Database session

    Returns:
        list[str]: Ordered list of preview headers

    Raises:
        NotFoundException: If manufacturing type not found

    Example:
        GET /api/v1/admin/entry/profile/headers/1
        Response: ["id", "Name", "Type", "Material", "Company", ...]
    """
    from app.services.entry import EntryService

    entry_service = EntryService(db)
    return await entry_service.generate_preview_headers(manufacturing_type_id)


@router.post(
    "/profile/save",
    response_model=Configuration,
    status_code=status.HTTP_201_CREATED,
    summary="Save Profile Data (Admin)",
    description="Save profile configuration data and create configuration record (admin interface)",
    response_description="Created configuration",
    operation_id="saveAdminProfileData",
    responses={
        201: {
            "description": "Profile data successfully saved",
        },
        404: {
            "description": "Manufacturing type not found",
        },
        **get_common_responses(401, 403, 422, 500),
    },
)
async def save_profile_data(
    profile_data: ProfileEntryData,
    current_superuser: CurrentSuperuser,
    db: DBSession,
) -> Configuration:
    """Save profile configuration data (admin interface).

    Validates the profile data against schema rules and creates
    a new configuration with associated selections.

    Args:
        profile_data (ProfileEntryData): Profile data to save
        current_superuser (User): Current authenticated superuser
        db (AsyncSession): Database session

    Returns:
        Configuration: Created configuration

    Raises:
        ValidationException: If validation fails
        NotFoundException: If manufacturing type not found

    Example:
        POST /api/v1/admin/entry/profile/save
        {
            "manufacturing_type_id": 1,
            "name": "Living Room Window",
            "type": "Frame",
            "material": "Aluminum",
            "opening_system": "Casement",
            "system_series": "Kom800",
            "width": 48.5
        }
    """
    from app.services.entry import EntryService

    entry_service = EntryService(db)
    try:
        return await entry_service.save_profile_configuration(profile_data, current_superuser)
    except ValidationException as e:
        import logging
        logger = logging.getLogger("uvicorn.error")
        logger.error(f"Save Profile Validation Error: {str(e)}")
        if hasattr(e, 'field_errors') and e.field_errors:
            logger.error(f"Field Errors: {e.field_errors}")
            # Return structured error response with field errors
            raise HTTPException(
                status_code=422,
                detail={
                    "message": e.message,
                    "field_errors": e.field_errors,
                    "error_type": "validation_error"
                }
            )
        else:
            # Return generic validation error
            raise HTTPException(
                status_code=422,
                detail={
                    "message": str(e),
                    "error_type": "validation_error"
                }
            )
    except Exception as e:
        import logging
        logger = logging.getLogger("uvicorn.error")
        logger.error(f"Save Profile Unexpected Error: {str(e)}")
        logger.error(f"Error Type: {type(e).__name__}")
        if hasattr(e, 'field_errors'):
             logger.error(f"Field Errors: {e.field_errors}")
        raise HTTPException(
            status_code=500,
            detail={
                "message": "An unexpected error occurred while saving the configuration",
                "error_type": "server_error"
            }
        )


@router.get(
    "/profile/load/{configuration_id}",
    response_model=ProfileEntryData,
    summary="Load Profile Data (Admin)",
    description="Load profile configuration data and populate form fields (admin interface)",
    response_description="Profile data for form population",
    operation_id="loadAdminProfileData",
    responses={
        200: {
            "description": "Profile data successfully loaded",
        },
        404: {
            "description": "Configuration not found",
        },
        **get_common_responses(401, 403, 500),
    },
)
async def load_profile_data(
    configuration_id: PositiveInt,
    current_superuser: CurrentSuperuser,
    db: DBSession,
) -> ProfileEntryData:
    """Load profile configuration data for form population (admin interface).

    Retrieves the configuration and its selections, then populates
    the form data structure for editing.

    Args:
        configuration_id (PositiveInt): Configuration ID to load
        current_superuser (User): Current authenticated superuser
        db (AsyncSession): Database session

    Returns:
        ProfileEntryData: Populated form data

    Raises:
        NotFoundException: If configuration not found

    Example:
        GET /api/v1/admin/entry/profile/load/123
    """
    from app.services.entry import EntryService

    entry_service = EntryService(db)
    return await entry_service.load_profile_configuration(configuration_id, current_superuser)


@router.get(
    "/profile/preview/{configuration_id}",
    response_model=ProfilePreviewData,
    summary="Get Profile Preview (Admin)",
    description="Get preview table data for a configuration (admin interface)",
    response_description="Profile preview data with table structure",
    operation_id="getAdminProfilePreview",
    responses={
        200: {
            "description": "Successfully retrieved profile preview",
        },
        404: {
            "description": "Configuration not found",
        },
        **get_common_responses(401, 403, 500),
    },
)
async def get_profile_preview(
    configuration_id: PositiveInt,
    current_superuser: CurrentSuperuser,
    db: DBSession,
) -> ProfilePreviewData:
    """Get profile preview data for a configuration (admin interface).

    Generates preview table data matching CSV structure
    for the specified configuration.

    Args:
        configuration_id (PositiveInt): Configuration ID
        current_superuser (User): Current authenticated superuser
        db (AsyncSession): Database session

    Returns:
        ProfilePreviewData: Preview data with table structure

    Raises:
        NotFoundException: If configuration not found

    Example:
        GET /api/v1/admin/entry/profile/preview/123
    """
    from app.services.entry import EntryService

    entry_service = EntryService(db)
    return await entry_service.generate_preview_data(configuration_id, current_superuser)


@router.get(
    "/profile/previews/{manufacturing_type_id}",
    response_model=PreviewTable,
    summary="List Profile Previews (Admin)",
    description="List all profile configurations for a manufacturing type (admin interface)",
    response_description="Table with all configurations",
    operation_id="listAdminProfilePreviews",
    responses={
        200: {
            "description": "Successfully retrieved profile previews",
        },
        **get_common_responses(401, 403, 500),
    },
)
async def list_profile_previews(
    manufacturing_type_id: PositiveInt,
    current_superuser: CurrentSuperuser,
    db: DBSession,
) -> PreviewTable:
    """List all profile configuration previews (admin interface)."""
    from app.services.entry import EntryService

    entry_service = EntryService(db)
    return await entry_service.list_previews(manufacturing_type_id, current_superuser)


@router.patch(
    "/profile/preview/{configuration_id}/update-cell",
    response_model=Configuration,
    summary="Update Preview Cell (Admin)",
    description="Update a single field in a configuration from the table preview (admin interface)",
    response_description="Updated configuration",
    operation_id="updateAdminPreviewCell",
    responses={
        200: {
            "description": "Cell successfully updated",
        },
        404: {
            "description": "Configuration not found",
        },
        **get_common_responses(401, 403, 422, 500),
    },
)
async def update_preview_cell(
    configuration_id: PositiveInt,
    edit_req: InlineEditRequest,
    current_superuser: CurrentSuperuser,
    db: DBSession,
) -> Configuration:
    """Update a specific field in a configuration from the preview table (admin interface)."""
    from app.services.entry import EntryService

    entry_service = EntryService(db)
    return await entry_service.update_preview_value(
        configuration_id, edit_req.field, edit_req.value, current_superuser
    )


@router.delete(
    "/profile/configuration/{configuration_id}",
    status_code=status.HTTP_204_NO_CONTENT,
    summary="Delete Configuration (Admin)",
    description="Delete a profile configuration (admin interface)",
    operation_id="deleteAdminConfiguration",
    responses={
        204: {
            "description": "Configuration successfully deleted",
        },
        404: {
            "description": "Configuration not found",
        },
        **get_common_responses(401, 403, 500),
    },
)
async def delete_configuration(
    configuration_id: PositiveInt,
    current_superuser: CurrentSuperuser,
    db: DBSession,
) -> None:
    """Delete a configuration (admin interface)."""
    from app.services.entry import EntryService

    entry_service = EntryService(db)
    await entry_service.delete_profile_configuration(configuration_id, current_superuser)


@router.post(
    "/upload-image",
    summary="Upload Image File (Admin)",
    description="Upload an image file for profile entry fields (admin interface)",
    response_description="Upload result with filename",
    operation_id="uploadAdminImage",
    responses={
        200: {
            "description": "Image uploaded successfully",
            "content": {
                "application/json": {
                    "example": {
                        "success": True,
                        "filename": "uploaded_image_123456.jpg",
                        "url": "https://example.com/path/to/image.jpg",
                        "message": "Image uploaded successfully"
                    }
                }
            }
        },
        400: {
            "description": "Invalid file or upload error",
            "content": {
                "application/json": {
                    "example": {
                        "success": False,
                        "error": "Invalid file type. Only images are allowed."
                    }
                }
            }
        }
    },
)
async def upload_image(
    request: Request,
    current_superuser: CurrentSuperuser,
) -> dict[str, Any]:
    """Upload an image file for profile entry fields (admin interface)."""
    from app.services.storage import get_storage_service
    
    try:
        # Parse multipart form data
        form_data = await request.form()
        file = form_data.get("file")
        
        print(f"ðŸ¦† [BACKEND DEBUG] Upload endpoint called")
        print(f"ðŸ¦† [BACKEND DEBUG] form_data keys: {list(form_data.keys())}")
        print(f"ðŸ¦† [BACKEND DEBUG] file object: {file}")
        print(f"ðŸ¦† [BACKEND DEBUG] file type: {type(file)}")
        
        if not file:
            print(f"ðŸ¦† [BACKEND DEBUG] âŒ No file in form data")
            return {
                "success": False,
                "error": "No file provided"
            }
        
        # Check if it's a proper file object
        if not hasattr(file, 'filename') or not hasattr(file, 'read'):
            print(f"ðŸ¦† [BACKEND DEBUG] âŒ Invalid file object - missing filename or read method")
            print(f"ðŸ¦† [BACKEND DEBUG] file attributes: {dir(file)}")
            return {
                "success": False,
                "error": "Invalid file object"
            }
        
        print(f"ðŸ¦† [BACKEND DEBUG] file.filename: {file.filename}")
        print(f"ðŸ¦† [BACKEND DEBUG] file content_type: {getattr(file, 'content_type', 'unknown')}")
        
        # Use the storage service to handle the upload
        storage_service = get_storage_service()
        print(f"ðŸ¦† [BACKEND DEBUG] Calling storage service upload_file...")
        result = await storage_service.upload_file(file)
        
        print(f"ðŸ¦† [BACKEND DEBUG] Upload result: {result}")
        
        if result.success:
            return {
                "success": True,
                "filename": result.filename,
                "url": result.url,
                "message": "Image uploaded successfully"
            }
        else:
            return {
                "success": False,
                "error": result.error or "Upload failed"
            }
        
    except Exception as e:
        print(f"ðŸ¦† [BACKEND DEBUG] âŒ Exception in upload endpoint: {e}")
        print(f"ðŸ¦† [BACKEND DEBUG] Exception type: {type(e)}")
        import traceback
        print(f"ðŸ¦† [BACKEND DEBUG] Traceback: {traceback.format_exc()}")
        return {
            "success": False,
            "error": f"Upload failed: {str(e)}"
        }



@router.post(
    "/profile/evaluate-conditions",
    summary="Evaluate Display Conditions (Admin)",
    description="Evaluate conditional field visibility based on form data (admin interface)",
    response_description="Field visibility map",
    operation_id="evaluateAdminDisplayConditions",
    responses={
        200: {
            "description": "Successfully evaluated conditions",
        },
        **get_common_responses(401, 403, 422, 500),
    },
)
async def evaluate_display_conditions(
    manufacturing_type_id: PositiveInt,
    form_data: dict[str, Any],
    current_superuser: CurrentSuperuser,
    db: DBSession,
):
    """Evaluate display conditions for conditional field visibility (admin interface).

    Evaluates all conditional display rules against the current form data
    to determine which fields should be visible.

    Args:
        manufacturing_type_id (PositiveInt): Manufacturing type ID
        form_data (dict): Current form data
        current_superuser (User): Current authenticated superuser
        db (AsyncSession): Database session

    Returns:
        dict[str, bool]: Field visibility map

    Example:
        POST /api/v1/admin/entry/profile/evaluate-conditions
        {
            "manufacturing_type_id": 1,
            "form_data": {
                "type": "Frame",
                "opening_system": "sliding"
            }
        }
    """
    from app.services.entry import EntryService

    entry_service = EntryService(db)
    schema = await entry_service.get_profile_schema(manufacturing_type_id)
    return await entry_service.evaluate_display_conditions(form_data, schema)


@router.post(
    "/profile/validate-business-rules",
    response_model=dict[str, str],
    summary="Validate Business Rules (Admin)",
    description="Validate business rules for profile data and return field-specific errors",
    response_description="Field errors from business rule violations",
    operation_id="validateAdminBusinessRules",
    responses={
        200: {
            "description": "Business rules validation completed",
            "content": {
                "application/json": {
                    "example": {
                        "renovation": "Renovation is only applicable for frame types",
                        "sash_overlap": "Sash overlap is only applicable for sash types"
                    }
                }
            }
        },
        422: {"description": "Validation Error"},
    },
)
async def validate_business_rules(
    form_data: dict[str, Any],
    current_superuser: CurrentSuperuser,
    db: DBSession,
) -> dict[str, str]:
    """Validate business rules for profile data (admin interface).

    Validates business rules for type-based field availability and returns
    field-specific error messages for any violations.

    Args:
        form_data (dict): Form data to validate
        current_superuser (User): Current authenticated superuser
        db (AsyncSession): Database session

    Returns:
        dict[str, str]: Field errors from business rule violations

    Example:
        POST /api/v1/admin/entry/profile/validate-business-rules
        {
            "type": "sash",
            "renovation": "yes",
            "sash_overlap": "8"
        }
        
        Response: {"renovation": "Renovation is only applicable for frame types"}
    """
    from app.services.entry import EntryService

    entry_service = EntryService(db)
    return entry_service.validate_business_rules(form_data)


# HTML Page Endpoints


@router.get(
    "/profile",
    response_class=HTMLResponse,
    summary="Admin Profile Entry Page",
    description="Render the admin profile data entry page",
    operation_id="adminProfileEntryPage",
    responses={
        200: {
            "description": "Admin profile entry page rendered successfully",
            "content": {"text/html": {"example": "<html>...</html>"}},
        },
        **get_common_responses(401, 403, 500),
    },
)
async def profile_page(
    request: Request,
    current_superuser: CurrentSuperuser,
    db: DBSession,
    manufacturing_type_id: Annotated[
        PositiveInt | None,
        Query(description="Manufacturing type ID for form generation"),
    ] = None,
) -> HTMLResponse:
    """Render the admin profile data entry page.

    Displays the profile entry page with dynamic form generation
    and real-time preview capabilities within the admin interface.

    Args:
        request (Request): FastAPI request object
        current_superuser (User): Current authenticated superuser
        db (AsyncSession): Database session
        manufacturing_type_id (PositiveInt | None): Optional manufacturing type ID

    Returns:
        HTMLResponse: Rendered HTML page

    Example:
        GET /api/v1/admin/entry/profile?manufacturing_type_id=1
    """
    from app.core.manufacturing_type_resolver import ManufacturingTypeResolver
    from app.services.entry import JAVASCRIPT_CONDITION_EVALUATOR

    # If no manufacturing_type_id provided, resolve the default profile entry type
    if manufacturing_type_id is None:
        default_type = await ManufacturingTypeResolver.get_default_profile_entry_type(db)
        if default_type:
            manufacturing_type_id = default_type.id
        else:
            # No manufacturing types exist - show error page or redirect to setup
            return templates.TemplateResponse(
                request,
                "admin/error.html.jinja",
                get_admin_context(
                    request,
                    current_superuser,
                    error_message="No manufacturing types found. Please run the setup script.",
                    page_title="Setup Required",
                ),
                status_code=503,
            )

    return templates.TemplateResponse(
        request,
        "admin/entry/profile.html.jinja",
        get_admin_context(
            request,
            current_superuser,
            active_page="entry_profile",
            manufacturing_type_id=manufacturing_type_id,
            page_title="Profile Entry",
            JAVASCRIPT_CONDITION_EVALUATOR=JAVASCRIPT_CONDITION_EVALUATOR,
            can_edit=True,  # TODO: Implement granular RBAC check
            can_delete=True,  # TODO: Implement granular RBAC check
        ),
    )



@router.get(
    "/accessories",
    response_class=HTMLResponse,
    summary="Admin Accessories Entry Page",
    description="Render the admin accessories data entry page (scaffold)",
    operation_id="adminAccessoriesEntryPage",
    responses={
        200: {
            "description": "Admin accessories entry page rendered successfully",
            "content": {"text/html": {"example": "<html>...</html>"}},
        },
        **get_common_responses(401, 403, 500),
    },
)
async def accessories_page(
    request: Request,
    current_superuser: CurrentSuperuser,
) -> HTMLResponse:
    """Render the admin accessories data entry page (scaffold).

    Displays a scaffold page for future accessories data entry implementation
    within the admin interface.

    Args:
        request (Request): FastAPI request object
        current_superuser (User): Current authenticated superuser

    Returns:
        HTMLResponse: Rendered HTML page

    Example:
        GET /api/v1/admin/entry/accessories
    """
    return templates.TemplateResponse(
        request,
        "admin/entry/accessories.html.jinja",
        get_admin_context(
            request,
            current_superuser,
            active_page="entry_accessories",
            page_title="Accessories Entry",
        ),
    )


@router.get(
    "/glazing",
    response_class=HTMLResponse,
    summary="Admin Glazing Entry Page",
    description="Render the admin glazing data entry page (scaffold)",
    operation_id="adminGlazingEntryPage",
    responses={
        200: {
            "description": "Admin glazing entry page rendered successfully",
            "content": {"text/html": {"example": "<html>...</html>"}},
        },
        **get_common_responses(401, 403, 500),
    },
)
async def glazing_page(
    request: Request,
    current_superuser: CurrentSuperuser,
) -> HTMLResponse:
    """Render the admin glazing data entry page (scaffold).

    Displays a scaffold page for future glazing data entry implementation
    within the admin interface.

    Args:
        request (Request): FastAPI request object
        current_superuser (User): Current authenticated superuser

    Returns:
        HTMLResponse: Rendered HTML page

    Example:
        GET /api/v1/admin/entry/glazing
    """
    return templates.TemplateResponse(
        request,
        "admin/entry/glazing.html.jinja",
        get_admin_context(
            request,
            current_superuser,
            active_page="entry_glazing",
            page_title="Glazing Entry",
        ),
    )