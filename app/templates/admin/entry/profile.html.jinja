{% extends "admin/base.html.jinja" %}
{% from "components/tables.html.jinja" import table_container with context %}

{% block title %}Profile Entry - {{ super() }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/profile-entry.css">
{% endblock %}

{% block content %}
<div x-data="profileEntryApp()" x-init="init()" class="space-y-6">
    <!-- Navigation Tabs -->
    <div class="navigation-tabs">
        <a href="/api/v1/admin/entry/profile" class="nav-tab active">
            <i class="fas fa-user-cog mr-2"></i>Profile
        </a>
        <a href="/api/v1/admin/entry/accessories" class="nav-tab">
            <i class="fas fa-puzzle-piece mr-2"></i>Accessories
        </a>
        <a href="/api/v1/admin/entry/glazing" class="nav-tab">
            <i class="fas fa-window-maximize mr-2"></i>Glazing
        </a>
    </div>

    <!-- Page Header -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Profile Data Entry</h1>
                <p class="text-gray-600 mt-1">Enter product profile information with real-time preview</p>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="text-center py-12">
        <div class="loading-spinner mx-auto mb-4" style="width: 2rem; height: 2rem;"></div>
        <p class="text-gray-600">Loading form schema...</p>
    </div>

    <!-- Error State -->
    <div x-show="error" class="bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
            <span class="text-red-700" x-text="error"></span>
        </div>
    </div>

    <!-- Tabbed Interface Layout -->
    <div x-show="schema && !loading" class="tabbed-interface">
        <!-- Tab Buttons -->
        <div class="tab-buttons">
            <button class="tab-btn active" @click="switchTab('input')" :class="{ 'active': activeTab === 'input' }">
                <i class="fas fa-edit mr-2"></i>Input
            </button>
            <button class="tab-btn" @click="switchTab('preview')" :class="{ 'active': activeTab === 'preview' }">
                <i class="fas fa-eye mr-2"></i>Preview
            </button>
        </div>
        
        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Input Tab -->
            <div x-show="activeTab === 'input'" class="tab-pane" id="input-tab">
                <div class="simple-field-list">
                    <form @submit.prevent="saveConfiguration()">
                        <!-- Dynamic Form Fields -->
                        <template x-for="section in schema.sections" :key="section.title">
                            <div class="form-section mb-8">
                                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4" 
                                    x-text="section.title"
                                    x-show="section.fields.some(f => isFieldVisible(f.name))"></h3>
                                <template x-for="field in section.fields" :key="field.name">
                                <div class="field-item" 
                                     :class="{ 
                                         'hidden': !isFieldVisible(field.name),
                                         'error': fieldErrors[field.name]
                                     }"
                                     x-show="isFieldVisible(field.name)"
                                     x-transition:enter="transition ease-out duration-300"
                                     x-transition:enter-start="opacity-0 transform scale-95"
                                     x-transition:enter-end="opacity-100 transform scale-100">
                                    
                                    <!-- Field Label -->
                                    <label class="field-label" :for="field.name">
                                        <span x-text="field.label"></span>
                                        <span x-show="field.required" class="text-red-500 ml-1">*</span>
                                        <span x-show="field.description && field.description !== field.label" 
                                              class="text-gray-400 text-xs ml-2 font-normal italic" 
                                              x-text="'(' + field.description + ')'"></span>
                                    </label>
                                    
                                    <!-- Help Text -->
                                    <p x-show="field.help_text" class="field-help" x-text="field.help_text"></p>
                                    
                                    <!-- Dynamic Field Component -->
                                    <div x-html="renderField(field)"></div>
                                    
                                    <!-- Field Error -->
                                    <div x-show="fieldErrors[field.name]" 
                                         class="field-error"
                                         x-transition:enter="transition ease-out duration-200"
                                         x-transition:enter-start="opacity-0 transform -translate-y-1"
                                         x-transition:enter-end="opacity-100 transform translate-y-0"
                                         x-text="fieldErrors[field.name]"></div>
                                    
                                    <!-- Field Success (optional) -->
                                    <div x-show="!fieldErrors[field.name] && field.required && formData[field.name] && formData[field.name] !== ''" 
                                         class="field-success">
                                        <i class="fas fa-check-circle mr-1"></i>Valid
                                    </div>
                                </div>
                            </template>
                        </template>
                    </form>
                </div>
            </div>

            <!-- Preview Tab -->
            <div x-show="activeTab === 'preview'" class="tab-pane" id="preview-tab">
                {% call table_container(title="Configuration Preview", description="Live preview of the current configuration as it will appear in the system") %}
                    <thead class="bg-gradient-to-r from-gray-50 to-gray-100/50 border-b border-gray-200">
                        <tr>
                            <template x-for="header in previewHeaders" :key="header">
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider" 
                                    x-text="header" 
                                    :title="header.replace(/\\n/g, ' ')"></th>
                            </template>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr class="border-b border-gray-100 transition-all duration-150 hover:bg-gray-50/50">
                            <template x-for="header in previewHeaders" :key="header">
                                <td class="px-4 py-3 text-sm text-gray-900 border-r border-gray-100" :title="getPreviewValue(header)">
                                    <span :class="{ 
                                        'na-value': !getPreviewValue(header) || getPreviewValue(header) === 'N/A',
                                        'value-changed': isValueChanged(header)
                                    }" x-text="getPreviewValue(header) || 'N/A'"></span>
                                </td>
                            </template>
                        </tr>
                    </tbody>
                {% endcall %}
            </div>
                    
                    <!-- Preview Summary -->
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">
                                <i class="fas fa-info-circle mr-1"></i>
                                Fields completed: <span class="font-medium" x-text="getCompletedFieldsCount()"></span> / <span x-text="getTotalFieldsCount()"></span>
                            </span>
                            <span class="text-gray-600" x-show="hasUnsavedChanges()">
                                <i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>
                                Unsaved changes
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Pass server-side data to JavaScript
window.INITIAL_MANUFACTURING_TYPE_ID = {{ manufacturing_type_id or 'null' }};
</script>
{% endblock %}

{% block extra_js %}
<script src="/static/js/profile-entry.js"></script>
{% endblock %}